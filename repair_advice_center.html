<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 修理専門アドバイスセンター - キャンピングカー修理AI相談</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 50%, #dc3545 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #dc3545;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #666;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        /* タブナビゲーション */
        .tab-navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            min-width: 180px;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            background: linear-gradient(45deg, #20c997, #17a2b8);
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #dc3545, #ff6b6b);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .tab-btn.active:hover {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .search-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .search-title {
            color: #dc3545;
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #dc3545;
            border-radius: 10px;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.3);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #dc3545, #ff6b6b);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #dc3545;
            font-size: 1.2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc3545;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .keyword-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
            color: #856404;
        }
        
        .problem-item, .cost-item, .tool-item {
            margin: 5px 0;
            padding: 3px 0;
        }
        
        .cost-summary {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }

        .results-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .search-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-summary h3 {
            margin: 0 0 15px 0;
            font-size: 1.5rem;
        }

        .search-summary p {
            margin: 8px 0;
            font-size: 1.1rem;
        }

        .result-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .result-rank {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 20px;
            min-width: 60px;
        }

        .rank-number {
            background: #ff6b6b;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .relevance-icon {
            font-size: 1.5rem;
        }

        .result-title-section {
            flex: 1;
        }

        .result-title {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.4rem;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .result-meta span {
            background: #f8f9fa;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .result-content {
            margin-bottom: 20px;
        }

        .result-content h4 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
        }

        .result-content > div {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .cost-summary {
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .cost-list, .product-list, .link-list {
            margin: 0;
            padding-left: 20px;
        }

        .cost-list li, .product-list li {
            margin: 5px 0;
            color: #495057;
        }

        .link-list li {
            margin: 5px 0;
        }

        .link-list a {
            color: #007bff;
            text-decoration: none;
        }

        .link-list a:hover {
            text-decoration: underline;
        }

        .matched-keywords p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* 単一結果の場合の特別なスタイル */
        .search-info.single-result {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .result-item.single-result {
            border-left-color: #2ecc71;
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.2);
            background: linear-gradient(135deg, #ffffff 0%, #f8fffe 100%);
        }

        .result-item.single-result .rank-number {
            background: #2ecc71;
            font-size: 1.5rem;
            width: 50px;
            height: 50px;
        }

        .result-item.single-result .relevance-icon {
            font-size: 2rem;
        }

        /* 詳細表示用のスタイル */
        .structured-content {
            margin: 20px 0;
        }

        .structured-content > div {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }

        .problem-description {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .causes {
            border-left-color: #dc3545;
            background: #fff8f8;
        }

        .solutions {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .tools-needed {
            border-left-color: #ffc107;
            background: #fffdf5;
        }

        .repair-steps {
            margin: 20px 0;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            border-left: 4px solid #2196f3;
        }

        .steps-list {
            counter-reset: step-counter;
            padding-left: 0;
        }

        .steps-list li {
            counter-increment: step-counter;
            margin: 10px 0;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            padding-left: 50px;
        }

        .steps-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: #2196f3;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .detailed-costs {
            margin-top: 15px;
        }

        .cost-breakdown {
            display: grid;
            gap: 10px;
        }

        .cost-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .cost-header {
            margin-bottom: 8px;
        }

        .cost-range, .cost-single {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1rem;
        }

        .cost-description {
            color: #495057;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .cost-reason {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 3px solid #28a745;
            font-size: 0.9rem;
            color: #495057;
        }

        .cost-reason strong {
            color: #28a745;
        }

        .detailed-products {
            margin-top: 15px;
        }

        .product-details {
            display: grid;
            gap: 15px;
        }

        .product-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #17a2b8;
        }

        .product-item strong {
            color: #2c3e50;
            font-size: 1.1rem;
            display: block;
            margin-bottom: 8px;
        }

        .product-item p {
            color: #6c757d;
            margin: 0;
        }

        .repair-costs {
            margin: 20px 0;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .repair-costs h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .cost-item {
            background: white;
            border-left: 4px solid #28a745;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-weight: 500;
        }

        .warnings {
            margin: 20px 0;
            padding: 15px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .warning-list {
            display: grid;
            gap: 10px;
        }

        .warning-item {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .warning-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .warning-text {
            color: #856404;
            flex: 1;
        }

        .additional-resources {
            margin-top: 15px;
        }

        .resource-list {
            padding-left: 20px;
        }

        .resource-list li {
            margin: 8px 0;
            color: #495057;
        }

        .expandable-content {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .expand-btn {
            width: 100%;
            margin-bottom: 15px;
        }

        .full-content {
            margin-top: 15px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .content-text {
            line-height: 1.6;
            color: #495057;
            white-space: pre-wrap;
        }

        /* ユーザーフレンドリーな表示改善 */

        .quick-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
        }

        .quick-cost, .quick-products {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cost-highlight {
            font-size: 1.3rem;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
            text-align: center;
            padding: 10px;
            background: #fff5f5;
            border-radius: 8px;
            border: 2px solid #e74c3c;
        }
        
        .cost-item {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .no-costs {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* 修理手順のスタイル */
        .step-item {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 5px;
            font-weight: 500;
            line-height: 1.6;
        }

        .no-steps {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* 注意事項のスタイル */
        .warning-item {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 5px;
            font-weight: 500;
            line-height: 1.6;
        }

        .no-warnings {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .product-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .product-tag {
            background: #007bff;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tool-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tool-tag {
            background: #ffc107;
            color: #212529;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .detailed-sections {
            margin: 20px 0;
        }

        .collapsible-section {
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .section-header {
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .section-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .section-header.active .toggle-icon {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 20px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        .warning-section .section-header {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }

        .warning-section .section-header:hover {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        }

        .external-link {
            display: block;
            padding: 10px 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            color: #007bff;
            text-decoration: none;
            margin: 8px 0;
            transition: all 0.3s ease;
        }

        .external-link:hover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: translateX(5px);
        }

        /* 安全なリンクのスタイル */
        a[rel="noopener noreferrer"] {
            position: relative;
        }

        a[rel="noopener noreferrer"]::after {
            content: "🔒";
            font-size: 0.8rem;
            margin-left: 5px;
            opacity: 0.7;
        }

        .link-list {
            display: grid;
            gap: 10px;
        }

        /* 画像のような分かりやすいレイアウト */
        .problem-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border-left: 5px solid #dc3545;
        }

        .problem-icon {
            font-size: 2.5rem;
            margin-right: 20px;
        }

        .problem-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .troubleshooting-sections {
            margin: 30px 0;
        }

        .section-item {
            display: flex;
            margin-bottom: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 2px solid #007bff;
            border-style: solid;
        }

        .section-number {
            background: #007bff;
            color: white;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            flex-shrink: 0;
            border-radius: 8px 0 0 8px;
        }

        .section-content {
            flex: 1;
            padding: 25px;
        }

        .section-content h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .section-content p {
            margin: 0 0 15px 0;
            line-height: 1.6;
            color: #495057;
        }

        .safety-section {
            border-color: #ffc107;
        }

        /* 代替品の紹介セクション用スタイル */
        .alternative-products-section {
            border-color: #28a745;
        }

        .alternative-products-section .section-number {
            background: #28a745;
        }

        /* 岡山キャンピングカー修理サポートセンター用スタイル */
        .support-center-section {
            border-color: #dc3545;
        }

        .support-center-section .section-number {
            background: #dc3545;
        }

        .support-center-info {
            margin-top: 15px;
        }

        .contact-box, .service-box, .consultation-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .contact-box {
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
            border-color: #f5c6cb;
        }

        .service-box {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border-color: #b8daff;
        }

        .consultation-box {
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
            border-color: #ffeaa7;
        }

        .contact-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .contact-icon {
            font-size: 18px;
            margin-right: 10px;
            width: 24px;
            text-align: center;
        }

        .contact-label {
            font-weight: 600;
            color: #495057;
            margin-right: 8px;
            min-width: 80px;
        }

        .contact-value {
            color: #212529;
        }

        .contact-value a {
            color: #007bff;
            text-decoration: none;
        }

        .contact-value a:hover {
            text-decoration: underline;
        }

        .contact-note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 15px 0 10px 0;
            font-size: 14px;
            color: #856404;
        }

        .company-info {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            margin-top: 10px;
            font-style: italic;
        }

        .service-list, .consultation-list {
            margin: 10px 0;
            padding-left: 20px;
        }

        .service-list li, .consultation-list li {
            margin-bottom: 8px;
            color: #495057;
        }

        .consultation-note {
            margin-top: 10px;
            font-weight: 600;
            color: #495057;
        }

        .alternative-products {
            margin-top: 15px;
        }

        .product-category {
            margin-bottom: 30px;
        }

        .product-category h5 {
            color: #28a745;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #28a745;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .product-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .product-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
            border-color: #28a745;
        }

        .product-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1rem;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .product-price {
            color: #dc3545;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .product-description {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .product-link {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .product-link:hover {
            background: #218838;
            color: white;
            text-decoration: none;
            transform: translateY(-1px);
        }

        /* 商品検索機能用スタイル */
        .product-search-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #dee2e6;
        }

        .search-header h5 {
            color: #28a745;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .search-header p {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .search-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-controls .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-controls .search-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .search-controls .search-btn {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .search-controls .search-btn:hover {
            background: #218838;
        }

        .search-categories {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-btn:hover {
            border-color: #28a745;
            color: #28a745;
        }

        .category-btn.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        /* 検索結果の表示制御 */
        .product-category.hidden {
            display: none;
        }

        .product-item.hidden {
            display: none;
        }

        .product-item.highlight {
            border-color: #28a745;
            background: #f8fff9;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            .product-grid {
                grid-template-columns: 1fr;
            }
            
            .product-item {
                padding: 12px;
            }

            .search-controls {
                flex-direction: column;
            }

            .search-categories {
                justify-content: center;
            }
        }

        .safety-section .section-number {
            background: #ffc107;
            color: #212529;
        }

        .safety-warnings {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
        }

        .safety-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .safety-item:last-child {
            margin-bottom: 0;
        }

        .safety-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .safety-text {
            color: #856404;
            font-weight: 500;
        }

        .cause-list, .solution-steps, .maintenance-list {
            padding-left: 0;
            list-style: none;
        }

        .cause-list li, .maintenance-list li {
            margin: 8px 0;
            padding: 10px 15px;
            background: #f8f9fa;
            border: 2px solid #dc3545;
            border-style: solid;
            border-radius: 5px;
        }

        .solution-steps li {
            margin: 12px 0;
            padding: 15px 20px;
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-style: solid;
            border-radius: 5px;
            font-weight: 500;
        }

        .tools-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .tool-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #ffc107;
            border-style: solid;
        }

        .tool-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .tool-name {
            font-weight: 500;
            color: #495057;
        }

        .expert-section {
            border-color: #6f42c1;
        }

        .expert-section .section-number {
            background: #6f42c1;
        }

        .substitute-section {
            border-color: #17a2b8;
        }

        .substitute-section .section-number {
            background: #17a2b8;
        }

        .purchase-section {
            border-color: #fd7e14;
        }

        .purchase-section .section-number {
            background: #fd7e14;
        }

        .expert-advice {
            background: #f8f9ff;
            border: 1px solid #e3e6ff;
            border-radius: 10px;
            padding: 20px;
        }

        .expert-advice ul {
            margin: 10px 0 0 20px;
        }

        .expert-advice li {
            margin: 8px 0;
            color: #495057;
        }

        /* サポートセンター詳細情報のスタイル */
        .support-center-detailed {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
            border: 2px solid #6f42c1;
            border-radius: 15px;
        }

        .support-center-detailed h5 {
            margin: 0 0 15px 0;
            color: #6f42c1;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }

        .support-intro {
            margin: 0 0 20px 0;
            color: #495057;
            text-align: center;
            font-weight: 500;
        }

        .contact-details {
            margin-bottom: 25px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .contact-icon {
            font-size: 1.2rem;
            margin-right: 10px;
            width: 25px;
            text-align: center;
        }

        .contact-label {
            font-weight: bold;
            color: #6f42c1;
            min-width: 80px;
            margin-right: 10px;
        }

        .contact-value {
            color: #495057;
            flex: 1;
        }

        .contact-value a {
            color: #007bff;
            text-decoration: none;
        }

        .contact-value a:hover {
            text-decoration: underline;
        }

        .contact-note {
            margin: 10px 0 15px 0;
            padding: 8px 12px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            color: #856404;
            font-size: 0.9rem;
            font-style: italic;
        }

        .company-info {
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .service-list, .consultation-info {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e3f2fd;
        }

        .service-list h6, .consultation-info h6 {
            margin: 0 0 15px 0;
            color: #6f42c1;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .service-items, .consultation-items {
            padding-left: 20px;
            margin: 0;
        }

        .service-items li, .consultation-items li {
            margin: 8px 0;
            color: #495057;
            font-weight: 500;
        }

        .consultation-note {
            margin: 10px 0 0 0;
            color: #6c757d;
            font-style: italic;
        }

        /* 代用品・代替品セクションのスタイル */
        .substitute-products {
            margin: 20px 0;
        }

        .substitute-intro {
            margin: 0 0 20px 0;
            color: #495057;
            text-align: center;
            font-weight: 500;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .substitute-item {
            background: white;
            border: 2px solid #17a2b8;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .substitute-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .product-info h6 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1rem;
            font-weight: bold;
            line-height: 1.4;
        }

        .product-link {
            display: inline-block;
            color: #007bff;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .product-link:hover {
            background: #e3f2fd;
            color: #0056b3;
            text-decoration: none;
        }

        .product-type {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .type-badge {
            background: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* 部品購入情報セクションのスタイル */
        .purchase-info {
            margin: 20px 0;
        }

        .purchase-intro {
            margin: 0 0 20px 0;
            color: #495057;
            text-align: center;
            font-weight: 500;
        }

        .part-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .part-item {
            background: white;
            border: 2px solid #fd7e14;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .part-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .part-info h6 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1rem;
            font-weight: bold;
            line-height: 1.4;
        }

        .part-link {
            display: inline-block;
            color: #fd7e14;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 5px 10px;
            background: #fff5f0;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .part-link:hover {
            background: #fd7e14;
            color: white;
            text-decoration: none;
        }

        .part-search {
            display: inline-block;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .search-text {
            color: #6c757d;
            font-size: 0.9rem;
            font-style: italic;
        }

        .part-type {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .type-badge.purchase {
            background: #fd7e14;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .support-center {
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 20px;
            border: 2px solid #2196f3;
        }

        .support-center h3 {
            margin: 0 0 20px 0;
            color: #1565c0;
            font-size: 1.4rem;
            text-align: center;
        }

        .support-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .contact-info {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .contact-info p {
            margin: 5px 0;
            color: #495057;
        }

        /* トイレ問題の概要表示 */
        .problem-overview {
            margin: 20px 0;
        }

        .toilet-overview {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .toilet-overview h5 {
            margin: 0 0 20px 0;
            color: #155724;
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
        }

        .overview-content p {
            margin: 15px 0 10px 0;
            font-weight: bold;
            color: #2c3e50;
        }

        .symptom-list, .cause-overview {
            padding-left: 20px;
            margin: 10px 0 20px 0;
        }

        .symptom-list li, .cause-overview li {
            margin: 8px 0;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            color: #495057;
            font-weight: 500;
        }

        .symptom-list li {
            border-left-color: #dc3545;
        }

        .cause-overview li {
            border-left-color: #ffc107;
        }

        /* トイレ修理アドバイス専用スタイル */
        .toilet-repair-advice {
            margin: 20px 0;
        }

        .repair-step {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #007bff;
            border-style: solid;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .repair-step h5 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: bold;
            flex: 1;
        }

        .cost-badge {
            background: #e74c3c;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .cost-description {
            margin: 0 0 15px 0;
            color: #6c757d;
            font-size: 0.9rem;
            font-style: italic;
        }

        .step-details {
            padding-left: 0;
            list-style: none;
            margin: 0;
        }

        .step-details li {
            margin: 10px 0;
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #28a745;
            border-style: solid;
            color: #495057;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .step-details li:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .step-details li::before {
            content: "✓";
            color: #28a745;
            font-weight: bold;
            margin-right: 10px;
        }


        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .quick-info {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .result-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .result-rank {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .result-meta {
                justify-content: center;
                flex-wrap: wrap;
            }

            .section-item {
                flex-direction: column;
            }

            .section-number {
                width: 100%;
                height: 50px;
                border-radius: 0;
            }

            .support-info {
                grid-template-columns: 1fr;
            }

            .tools-list {
                grid-template-columns: 1fr;
            }

            .step-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .cost-badge {
                margin-left: 0;
                margin-top: 8px;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }

            .part-grid {
                grid-template-columns: 1fr;
            }
        }

        .result-item {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #dc3545;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .result-title {
            color: #dc3545;
            font-size: 1.4rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .result-category {
            background: #dc3545;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 15px;
        }

        .result-content {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .result-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        /* 費用目安表示用のスタイル */
        .cost-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }

        .cost-info .result-title {
            color: #856404;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cost-info .result-content {
            color: #856404;
            font-weight: 500;
            line-height: 1.8;
        }

        .cost-info .result-content strong {
            color: #dc3545;
            font-weight: bold;
        }

        .cost-item {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #ffc107;
        }

        .cost-item:first-child {
            margin-top: 0;
        }

        .cost-item:last-child {
            margin-bottom: 0;
        }

        .cost-info, .product-info, .url-info {
            margin-bottom: 10px;
        }

        .cost-info strong, .product-info strong, .url-info strong {
            color: #dc3545;
        }

        .url-link {
            color: #dc3545;
            text-decoration: none;
            margin-right: 10px;
        }

        .url-link:hover {
            text-decoration: underline;
        }

        /* no-results スタイルは削除 */

        /* フォールバック関連のスタイルは削除 */

        .suggestions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .suggestions h4 {
            color: #dc3545;
            margin-bottom: 15px;
        }

        .suggestion-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .suggestion-tag {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-tag:hover {
            background: #ff6b6b;
            transform: translateY(-1px);
        }

        .footer {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: #666;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .footer a {
            color: #dc3545;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* レスポンシブデザイン */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .search-form {
                flex-direction: column;
            }

            .search-input, .search-btn {
                width: 100%;
            }

            .suggestion-tags {
                justify-content: center;
            }
        }

        /* 整理されたセクション用スタイル */
        .organized-sections {
            margin: 20px 0;
        }

        .section-item {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-title {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-content {
            color: #495057;
            line-height: 1.6;
        }

        .section-content ul, .section-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .section-content li {
            margin: 8px 0;
        }

        .section-content p {
            margin: 10px 0;
        }

        /* セクション別の色分け */
        .section-item:nth-child(1) { border-left-color: #28a745; } /* 問題の種類 */
        .section-item:nth-child(2) { border-left-color: #dc3545; } /* 修理費用 */
        .section-item:nth-child(3) { border-left-color: #ffc107; } /* 工具・部品 */
        .section-item:nth-child(4) { border-left-color: #17a2b8; } /* 修理手順 */
        .section-item:nth-child(5) { border-left-color: #6f42c1; } /* 注意事項 */

        /* アニメーション */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <div class="header fade-in">
            <h1>🔧 修理専門アドバイスセンター</h1>
            <p>具体的な修理費相場、代替品をご紹介</p>
            <p>キャンピングカーの修理・メンテナンスに関する専門的なアドバイスを提供します</p>
            
            <!-- タブナビゲーション - 非表示 -->
            <!--
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="openAppPy()">
                    🚀 アプリケーション起動
                </button>
                <button class="tab-btn" onclick="openFrontend()">
                    🌐 フロントエンド表示
                </button>
                <button class="tab-btn" onclick="openBackend()">
                    ⚙️ バックエンド管理
                </button>
            </div>
            -->
        </div>

        <!-- 検索セクション -->
        <div class="search-section fade-in">
            <h2 class="search-title">🔍 修理アドバイス検索</h2>
            <form class="search-form" id="searchForm">
                <input type="text" class="search-input" id="searchInput" 
                       placeholder="例: バッテリー、雨漏り、エアコン、トイレ、ガスコンロ..." 
                       required>
                <button type="submit" class="search-btn">🔍 検索</button>
            </form>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>⏳ 回答時間に少々お時間をください。専門的な情報を収集・整理しております。</p>
            </div>
        </div>

        <!-- 検索結果セクション -->
        <div class="results-section" id="resultsSection">
            <h2 class="search-title">📋 検索結果</h2>
            <div id="resultsContainer"></div>
        </div>

        <!-- フッター -->
        <div class="footer fade-in">
            <p>© 2024 キャンピングカー修理AI相談システム</p>
            <p>より詳細な相談は <a href="http://localhost:8501/" target="_blank">AIチャット相談</a> または <a href="http://localhost:8501/" target="_blank">対話式症状診断</a> をご利用ください</p>
        </div>
    </div>

    <script>
        // デバッグ機能の追加
        console.log('🔧 検索機能デバッグ開始');
        console.log('📋 DOM要素チェック:');
        console.log('  - searchForm:', document.getElementById('searchForm'));
        console.log('  - searchInput:', document.getElementById('searchInput'));
        console.log('  - loading:', document.getElementById('loading'));
        console.log('  - resultsSection:', document.getElementById('resultsSection'));
        
        // 検索フォームの処理（改善版）
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            console.log('🔍 検索フォーム送信:', query);
            
            if (!query) {
                alert('検索キーワードを入力してください。');
                return;
            }
            
            // ローディング表示
            showLoading();
            
            try {
                console.log('⏳ 検索処理開始...');
                console.log('🔍 検索クエリ:', query);
                
                // 実際の検索処理
                const results = await searchRepairAdvice(query);
                console.log('📋 検索結果取得:', results);
                console.log('📊 結果の詳細:', JSON.stringify(results, null, 2));
                console.log('📊 結果の型:', typeof results);
                console.log('📊 結果の長さ:', results ? results.length : 'undefined');
                
                if (results && results.length > 0) {
                    console.log('✅ 結果を表示します');
                    displayResults(results, query);
                } else {
                    console.log('⚠️ 検索結果が空です');
                    displayError('検索結果が見つかりませんでした。別のキーワードでお試しください。');
                }
            } catch (error) {
                console.error('❌ 検索エラー:', error);
                console.error('❌ エラー詳細:', error.stack);
                displayError(`検索中にエラーが発生しました: ${error.message}`);
            } finally {
                hideLoading();
            }
        });

        // ローディング表示（改善版）
        function showLoading() {
            console.log('⏳ ローディング表示開始');
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultsSection').classList.remove('show');
        }

        // ローディング非表示（改善版）
        function hideLoading() {
            console.log('✅ ローディング表示終了');
            document.getElementById('loading').classList.remove('show');
        }

        // サーバー状態チェック
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/health', {
                    method: 'GET',
                    timeout: 3000
                });
                return response.ok;
            } catch (error) {
                console.log('サーバー接続エラー:', error);
                return false;
            }
        }

        // 検索処理（改善版 - テキストファイル検索とRAGシステム対応）
        async function searchRepairAdvice(query) {
            try {
                console.log('🔍 検索開始:', query);
                
                // サーバー状態をチェック
                const serverOnline = await checkServerStatus();
                console.log('🌐 サーバー状態:', serverOnline);
                if (!serverOnline) {
                    console.log('⚠️ サーバーがオフラインです。モックデータを使用します。');
                    return getMockResults(query);
                }

                console.log('🌐 RAGシステム検索中...');
                const ragResponse = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });
                
                console.log('📡 RAGレスポンス状態:', ragResponse.status);
                let ragResults = [];
                if (ragResponse.ok) {
                    const ragData = await ragResponse.json();
                    console.log('📊 RAGデータ:', ragData);
                    if (ragData.results) {
                        ragResults = ragData.results;
                        console.log('✅ RAG検索完了:', ragResults.length, '件');
                    } else {
                        console.log('⚠️ RAG検索結果が空または失敗');
                    }
                } else {
                    console.log('❌ RAG検索エラー:', ragResponse.status);
                }
                
                console.log('📄 テキストファイル検索中...');
                const textResponse = await fetch('/api/search_text_files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });
                
                console.log('📡 テキストレスポンス状態:', textResponse.status);
                let textResults = [];
                if (textResponse.ok) {
                    const textData = await textResponse.json();
                    console.log('📊 テキストデータ:', textData);
                    if (textData.results) {
                        textResults = textData.results;
                        console.log('✅ テキストファイル検索完了:', textResults.length, '件');
                    } else {
                        console.log('⚠️ テキスト検索結果が空または失敗');
                    }
                } else {
                    console.log('❌ テキスト検索エラー:', textResponse.status);
                }
                
                // 結果を統合
                const allResults = [...ragResults, ...textResults];
                console.log('✅ 統合検索完了:', allResults.length, '件');
                console.log('📊 統合結果詳細:', JSON.stringify(allResults, null, 2));
                
                if (allResults.length > 0) {
                    console.log('✅ 検索結果を返します:', allResults.length, '件');
                    return allResults;
                } else {
                    console.log('⚠️ 検索結果なし、モックデータを使用');
                    const mockResults = getMockResults(query);
                    console.log('📊 モック結果:', mockResults.length, '件');
                    return mockResults;
                }
                
            } catch (error) {
                console.error('❌ 検索エラー:', error);
                console.log('🔧 フォールバック: モックデータを使用します');
                return getMockResults(query);
            }
        }

        // キーワードハイライト機能
        function highlightKeywords(text, query) {
            if (!text || !query) return text;
            
            const keywords = query.split(' ').filter(word => word.length > 1);
            let highlightedText = text;
            
            keywords.forEach(keyword => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                highlightedText = highlightedText.replace(regex, '<mark class="keyword-highlight">$1</mark>');
            });
            
            return highlightedText;
        }

        // 費用目安情報のフォーマット
        function formatCostInformation(content) {
            if (!content) return '';
            
            // 費用情報を行ごとに分割
            const lines = content.split('\n').filter(line => line.trim());
            let formattedHtml = '';
            
            lines.forEach(line => {
                if (line.includes('円')) {
                    // 費用情報の行を特別にフォーマット
                    const costItem = line.replace(/\*\*/g, '').trim();
                    formattedHtml += `<div class="cost-item">${costItem}</div>`;
                } else if (line.trim()) {
                    // その他の情報
                    formattedHtml += `<div class="cost-description">${line.trim()}</div>`;
                }
            });
            
            return formattedHtml;
        }

        // 問題の種類を取得（改善版 - エアコン対応）
        function getProblemTypes(result, query) {
            const problems = [];
            
            // 構造化されたデータから問題を抽出
            if (result.structured_content && result.structured_content.problem_description) {
                problems.push(result.structured_content.problem_description);
            }
            
            // コンテンツから問題を抽出（エアコン専用）
            if (result.content) {
                const content = result.content.toLowerCase();
                
                // エアコン特有の問題パターン
                if (content.includes('冷風が出ない') || content.includes('冷えない')) {
                    problems.push('冷風が出ない・冷えない');
                }
                if (content.includes('電源が入らない') || content.includes('電源')) {
                    problems.push('電源が入らない・電源異常');
                }
                if (content.includes('異音') || content.includes('音がする')) {
                    problems.push('異音・騒音');
                }
                if (content.includes('水漏れ') || content.includes('水が漏れる')) {
                    problems.push('水漏れ・液体漏れ');
                }
                if (content.includes('リモコン') || content.includes('リモコンが効かない')) {
                    problems.push('リモコンが効かない・操作不良');
                }
                
                // 一般的な問題パターン
                if (content.includes('故障') || content.includes('不具合') || content.includes('問題')) {
                    problems.push('機器の故障・不具合');
                }
                if (content.includes('電気') || content.includes('電源')) {
                    problems.push('電気系統の問題');
                }
            }
            
            // キーワードマッチング（エアコン強化 - カテゴリー候補と主要キーワード対応）
            if (query) {
                const queryLower = query.toLowerCase();
                
                // エアコン関連のカテゴリー候補
                if (queryLower.includes('エアコン') || queryLower.includes('aircon')) {
                    problems.push('エアコン・冷房システム');
                }
                if (queryLower.includes('冷暖房') || queryLower.includes('冷暖房システム')) {
                    problems.push('冷暖房システム');
                }
                if (queryLower.includes('車載クーラー') || queryLower.includes('クーラー')) {
                    problems.push('車載クーラー');
                }
                if (queryLower.includes('室内空調') || queryLower.includes('空調')) {
                    problems.push('室内空調');
                }
                if (queryLower.includes('クライメート') || queryLower.includes('クライメートコントロール')) {
                    problems.push('クライメートコントロール');
                }
                
                // トイレ関連のカテゴリー候補
                if (queryLower.includes('トイレ') || queryLower.includes('toilet')) {
                    problems.push('トイレ・便器システム');
                }
                if (queryLower.includes('カセット') || queryLower.includes('カセットトイレ')) {
                    problems.push('カセットトイレ');
                }
                if (queryLower.includes('水漏れ') || queryLower.includes('水が漏れる')) {
                    problems.push('水漏れ・給水システム');
                }
                if (queryLower.includes('詰まり') || queryLower.includes('排水が流れない')) {
                    problems.push('排水・詰まり');
                }
                if (queryLower.includes('フラップ') || queryLower.includes('バルブ')) {
                    problems.push('フラップ・バルブシステム');
                }
                
                // エアコン関連の主要キーワード
                if (queryLower.includes('冷房') || queryLower.includes('冷風') || queryLower.includes('冷えない')) {
                    problems.push('冷房・冷風が出ない');
                }
                if (queryLower.includes('暖房') || queryLower.includes('暖風')) {
                    problems.push('暖房・暖風システム');
                }
                if (queryLower.includes('コンプレッサー')) {
                    problems.push('コンプレッサー関連の問題');
                }
                if (queryLower.includes('ガス漏れ') || queryLower.includes('ガス')) {
                    problems.push('ガス漏れ・冷媒漏れ');
                }
                if (queryLower.includes('エアコンフィルター') || queryLower.includes('フィルター')) {
                    problems.push('エアコンフィルター・清掃');
                }
                if (queryLower.includes('風量') || queryLower.includes('風')) {
                    problems.push('風量・送風の問題');
                }
                if (queryLower.includes('温度調整') || queryLower.includes('温度')) {
                    problems.push('温度調整・温度制御');
                }
                if (queryLower.includes('冷媒')) {
                    problems.push('冷媒・冷媒ガス');
                }
                if (queryLower.includes('故障') || queryLower.includes('不具合')) {
                    problems.push('エアコン故障・不具合');
                }
                
                // 一般的な問題パターン
                if (queryLower.includes('電源') || queryLower.includes('電源が入らない')) {
                    problems.push('電源異常・電源が入らない');
                }
                if (queryLower.includes('異音') || queryLower.includes('音')) {
                    problems.push('異音・騒音');
                }
                if (queryLower.includes('水漏れ') || queryLower.includes('水漏れ')) {
                    problems.push('水漏れ・液体漏れ');
                }
                if (queryLower.includes('リモコン') || queryLower.includes('リモコンが効かない')) {
                    problems.push('リモコン操作不良');
                }
                if (queryLower.includes('バッテリー') || queryLower.includes('電池')) {
                    problems.push('バッテリー関連の問題');
                }
                if (queryLower.includes('タイヤ') || queryLower.includes('ホイール')) {
                    problems.push('タイヤ・ホイール関連');
                }
                if (queryLower.includes('ffヒーター') || queryLower.includes('ヒーター')) {
                    problems.push('FFヒーター・暖房システム');
                }
                if (queryLower.includes('水道') || queryLower.includes('ポンプ')) {
                    problems.push('水道・ポンプシステム');
                }
                if (queryLower.includes('雨漏り') || queryLower.includes('水漏れ')) {
                    problems.push('雨漏り・水漏れ問題');
                }
            }
            
            if (problems.length === 0) {
                problems.push('一般的な修理・メンテナンス');
            }
            
            return problems.map(problem => `<div class="problem-item">• ${highlightKeywords(problem, query)}</div>`).join('');
        }

        // エアコン関連キーワードをチェック
        function isAirconRelatedQuery(query) {
            const airconKeywords = [
                'エアコン', '冷房', '暖房', '空調', '冷えない', '暖まらない',
                'フィルター', 'リモコン', '温度', '冷媒', 'コンプレッサー',
                'AC', 'aircon', 'クーラー', 'ヒーター', '室外機', '室内機'
            ];
            
            const queryLower = query.toLowerCase();
            return airconKeywords.some(keyword => queryLower.includes(keyword));
        }

        // トイレ関連キーワードをチェック
        function isToiletRelatedQuery(query) {
            const toiletKeywords = [
                'トイレ', '便器', 'カセット', 'toilet', '水漏れ', '詰まり',
                '排水', 'ポンプ', 'フラップ', 'バルブ', 'シール'
            ];
            
            const queryLower = query.toLowerCase();
            return toiletKeywords.some(keyword => queryLower.includes(keyword));
        }

        // エアコン専用の修理手順を取得
        function getAirconRepairSteps() {
            return `
                <div class="step-item">
                    <strong>トラブル箇所の特定:</strong> 冷風の有無、ファンの動作確認、電源のON/OFF、リモコンの操作可否
                </div>
                <div class="step-item">
                    <strong>電圧測定・ヒューズ確認:</strong> 12V電圧の確認、ヒューズの状態チェック
                </div>
                <div class="step-item">
                    <strong>応急処置:</strong> バッテリー充電後再起動、ヒューズ交換、ドレンホース清掃
                </div>
                <div class="step-item">
                    <strong>本格修理:</strong> 冷媒ガス補充・真空引き、コンプレッサー・基板・ファンモーターの交換
                </div>
                <div class="step-item">
                    <strong>清掃作業:</strong> ドレンホース・室外ユニットの清掃、フィルター交換
                </div>
                <div class="step-item">
                    <strong>電子部品交換:</strong> リモコン・受光部・基板の交換、電源回路・ヒューズ・リレーの修理
                </div>
                <div class="step-item">
                    <strong>動作テスト:</strong> 冷房機能の確認、異音チェック、水漏れ確認
                </div>
                <div class="step-item">
                    <strong>予防策:</strong> 定期的なヒューズ・電圧チェック、冷媒漏れ点検
                </div>
            `;
        }

        // エアコン専用の注意事項を取得
        function getAirconWarnings() {
            return `
                <div class="warning-item">
                    <strong>車両電圧の安全確認:</strong> 12V電圧の確認、バッテリー状態の点検
                </div>
                <div class="warning-item">
                    <strong>冷媒フロン類管理:</strong> 法律順守、適切な回収・廃棄処理
                </div>
                <div class="warning-item">
                    <strong>高所・車外作業時の安全確保:</strong> 室外ユニット作業時の安全対策
                </div>
                <div class="warning-item">
                    <strong>専門業者以外での分解・改造禁止:</strong> 冷媒系統の作業は専門知識が必要
                </div>
                <div class="warning-item">
                    <strong>電気系統・高温部への注意:</strong> 感電・火傷の危険性
                </div>
                <div class="warning-item">
                    <strong>換気確保:</strong> 密閉空間での作業時は十分な換気を確保
                </div>
                <div class="warning-item">
                    <strong>工具の取り扱い:</strong> 電気工具の安全な使用
                </div>
                <div class="warning-item">
                    <strong>部品確認:</strong> 純正部品または適合部品を使用
                </div>
            `;
        }

        // 個別のresultオブジェクトから修理手順を取得
        function getRepairStepsFromResult(result, query) {
            console.log('🔧 getRepairStepsFromResult デバッグ:', {
                result: result,
                repair_steps: result.repair_steps,
                content: result.content ? result.content.substring(0, 100) + '...' : 'なし',
                title: result.title,
                category: result.category,
                source: result.source
            });
            
            // 構造化されたデータから修理手順を抽出
            if (result.repair_steps && Array.isArray(result.repair_steps) && result.repair_steps.length > 0) {
                console.log('✅ 配列形式の修理手順を発見:', result.repair_steps.length, '件');
                return result.repair_steps.map(step => `<div class="step-item">${step.trim()}</div>`).join('');
            } else if (result.repair_steps && typeof result.repair_steps === 'string' && result.repair_steps.trim()) {
                console.log('✅ 文字列形式の修理手順を発見');
                const stepLines = result.repair_steps.split('\n');
                return stepLines.map(line => line.trim()).filter(line => line).map(line => `<div class="step-item">${line}</div>`).join('');
            }
            
            // コンテンツから修理手順セクションを抽出
            if (result.content && result.content.includes('修理手順')) {
                console.log('✅ コンテンツから修理手順を抽出中...');
                const content = result.content;
                
                // 複数のパターンで修理手順を検索
                const patterns = [
                    /## 修理手順\s*\n(.*?)(?=\n##|\n⚠️|\n\*\*|$)/s,
                    /修理手順\s*\n(.*?)(?=\n##|\n⚠️|\n\*\*|$)/s,
                    /詳細修理手順\s*\n(.*?)(?=\n##|\n⚠️|\n\*\*|$)/s
                ];
                
                for (const pattern of patterns) {
                    const stepSectionMatch = content.match(pattern);
                    if (stepSectionMatch) {
                        console.log('✅ 修理手順セクションを発見');
                        const stepSection = stepSectionMatch[1];
                        const stepLines = stepSection.split('\n');
                        return stepLines.map(line => line.trim()).filter(line => line && !line.startsWith('---')).map(line => `<div class="step-item">${line}</div>`).join('');
                    }
                }
            }
            
            console.log('❌ 修理手順が見つかりませんでした');
            console.log('🔍 詳細デバッグ情報:');
            console.log('  - repair_steps存在:', !!result.repair_steps);
            console.log('  - repair_steps型:', typeof result.repair_steps);
            console.log('  - content存在:', !!result.content);
            console.log('  - contentに修理手順含む:', result.content ? result.content.includes('修理手順') : false);
            
            // フォールバック: エアコン関連のクエリの場合はデフォルト手順を表示
            if (query && (query.includes('エアコン') || query.includes('冷房') || query.includes('暖房'))) {
                console.log('🔄 エアコン関連フォールバック手順を表示');
                return `
                    <div class="step-item">1. <strong>問題箇所の特定</strong> - 冷風の有無、ファンの動作確認、電源のON/OFF、リモコンの操作可否</div>
                    <div class="step-item">2. <strong>安全確認と準備</strong> - 作業前に必ずブレーカーを落とす、高所作業では必ず安全帯を使用する</div>
                    <div class="step-item">3. <strong>部品の交換・修理</strong> - 冷媒ガス補充・真空引き、コンプレッサー・基板・ファンモーターの交換</div>
                    <div class="step-item">4. <strong>動作確認</strong> - 電源を入れて試運転し、動作確認を行う</div>
                    <div class="step-item">5. <strong>最終チェック</strong> - ガス漏れ検知を必ず行う、ドレンホースの傾斜を適切に取る</div>
                `;
            }
            
            // フォールバック: トイレ関連のクエリの場合はデフォルト手順を表示
            if (query && isToiletRelatedQuery(query)) {
                console.log('🔄 トイレ関連フォールバック手順を表示');
                return `
                    <div class="step-item">1. <strong>問題箇所の特定</strong> - 水漏れ：タンク・配管・バルブ接続部からの水漏れを確認、詰まり：排水が流れない、異物混入の有無を点検</div>
                    <div class="step-item">2. <strong>安全確認と準備</strong> - 作業前に必ず給水ポンプの電源をOFFにする、汚水タンクはゴム手袋・マスクを着用して取り外す</div>
                    <div class="step-item">3. <strong>部品の交換・修理</strong> - 水漏れ修理：Oリング・シールを交換し、接続部にシリコングリスを塗布、詰まり除去：ラバーカップ、専用クリーナーで詰まりを解消</div>
                    <div class="step-item">4. <strong>動作確認</strong> - 給水ポンプをONにして水の流れを確認、レバー操作でフラップがスムーズに開閉するか確認</div>
                    <div class="step-item">5. <strong>最終チェック</strong> - タンクの固定状態を確認し、走行中に揺れで外れないか点検、便座周囲・配管接続部の水漏れがないか確認</div>
                `;
            }
            
            return '<div class="no-steps">修理手順の情報がありません</div>';
        }

        // 個別のresultオブジェクトから注意事項を取得
        function getWarningsFromResult(result, query) {
            console.log('⚠️ getWarningsFromResult デバッグ:', {
                result: result,
                warnings: result.warnings,
                content: result.content ? result.content.substring(0, 100) + '...' : 'なし',
                title: result.title,
                category: result.category,
                source: result.source
            });
            
            // 構造化されたデータから注意事項を抽出
            if (result.warnings && Array.isArray(result.warnings) && result.warnings.length > 0) {
                console.log('✅ 配列形式の注意事項を発見:', result.warnings.length, '件');
                return result.warnings.map(warning => `<div class="warning-item">${warning.trim()}</div>`).join('');
            } else if (result.warnings && typeof result.warnings === 'string' && result.warnings.trim()) {
                console.log('✅ 文字列形式の注意事項を発見');
                const warningLines = result.warnings.split('\n');
                return warningLines.map(line => line.trim()).filter(line => line).map(line => `<div class="warning-item">${line}</div>`).join('');
            }
            
            // コンテンツから注意事項セクションを抽出
            if (result.content && result.content.includes('注意事項')) {
                console.log('✅ コンテンツから注意事項を抽出中...');
                const content = result.content;
                
                // 複数のパターンで注意事項を検索
                const patterns = [
                    /## 注意事項\s*\n(.*?)(?=\n##|\n\*\*|$)/s,
                    /⚠️ 注意事項\s*\n(.*?)(?=\n##|\n\*\*|$)/s,
                    /注意事項\s*\n(.*?)(?=\n##|\n\*\*|$)/s,
                    /安全上の注意事項\s*\n(.*?)(?=\n##|\n\*\*|$)/s
                ];
                
                for (const pattern of patterns) {
                    const warningSectionMatch = content.match(pattern);
                    if (warningSectionMatch) {
                        console.log('✅ 注意事項セクションを発見');
                        const warningSection = warningSectionMatch[1];
                        const warningLines = warningSection.split('\n');
                        return warningLines.map(line => line.trim()).filter(line => line && !line.startsWith('---')).map(line => `<div class="warning-item">${line}</div>`).join('');
                    }
                }
            }
            
            console.log('❌ 注意事項が見つかりませんでした');
            console.log('🔍 詳細デバッグ情報:');
            console.log('  - warnings存在:', !!result.warnings);
            console.log('  - warnings型:', typeof result.warnings);
            console.log('  - content存在:', !!result.content);
            console.log('  - contentに注意事項含む:', result.content ? result.content.includes('注意事項') : false);
            
            // フォールバック: エアコン関連のクエリの場合はデフォルト注意事項を表示
            if (query && (query.includes('エアコン') || query.includes('冷房') || query.includes('暖房'))) {
                console.log('🔄 エアコン関連フォールバック注意事項を表示');
                return `
                    <div class="warning-item">⚠️ <strong>安全第一で作業を行ってください</strong></div>
                    <div class="warning-item">- 専門知識が必要な場合は専門店に相談</div>
                    <div class="warning-item">- 工具の取り扱いには十分注意</div>
                    <div class="warning-item">- 車両電圧の安全確認</div>
                    <div class="warning-item">- 冷媒フロン類管理（法律順守）</div>
                    <div class="warning-item">- 高所・車外作業時の安全確保</div>
                    <div class="warning-item">- 専門業者以外での分解・改造禁止</div>
                    <div class="warning-item">- 電気系統・高温部への注意</div>
                `;
            }
            
            // フォールバック: トイレ関連のクエリの場合はデフォルト注意事項を表示
            if (query && isToiletRelatedQuery(query)) {
                console.log('🔄 トイレ関連フォールバック注意事項を表示');
                return `
                    <div class="warning-item">⚠️ <strong>安全第一で作業を行ってください</strong></div>
                    <div class="warning-item">- 専門知識が必要な場合は専門店に相談</div>
                    <div class="warning-item">- 必ず電源OFF・水栓閉鎖の状態で作業</div>
                    <div class="warning-item">- 排水・清掃時は必ずゴム手袋・マスクを着用</div>
                    <div class="warning-item">- 汚水タンクは必ず専用の処理場で廃棄（一般下水道禁止の場合あり）</div>
                    <div class="warning-item">- 強い薬剤やシンナーでの清掃は樹脂部品を劣化させるため使用禁止</div>
                    <div class="warning-item">- フラップ・シール部分には必ずシリコングリスを使用し、石油系潤滑剤は厳禁</div>
                    <div class="warning-item">- 漏電や水漏れが大きい場合は直ちに使用を中止し、専門業者へ相談</div>
                `;
            }
            
            return '<div class="no-warnings">注意事項の情報がありません</div>';
        }

        // 修理手順を取得（改良版）
        function getRepairSteps(results, query) {
            const steps = [];
            
            // デバッグ用ログ
            console.log('🔧 getRepairSteps デバッグ:', {
                results: results,
                results_length: Array.isArray(results) ? results.length : 'not array'
            });
            
            // results配列から修理手順を抽出
            if (Array.isArray(results)) {
                results.forEach(result => {
                    console.log('🔍 処理中の結果:', {
                        title: result.title,
                        category: result.category,
                        repair_steps: result.repair_steps,
                        content: result.content ? result.content.substring(0, 100) + '...' : 'なし'
                    });
                    
                    // 構造化されたデータから修理手順を抽出
                    if (result.repair_steps && Array.isArray(result.repair_steps)) {
                        console.log('✅ 配列形式の修理手順を発見:', result.repair_steps.length, '件');
                        result.repair_steps.forEach(step => {
                            if (step.trim()) {
                                steps.push(`<div class="step-item">${step.trim()}</div>`);
                            }
                        });
                    } else if (result.repair_steps && typeof result.repair_steps === 'string') {
                        console.log('✅ 文字列形式の修理手順を発見');
                        const stepLines = result.repair_steps.split('\n');
                        stepLines.forEach(line => {
                            if (line.trim()) {
                                steps.push(`<div class="step-item">${line.trim()}</div>`);
                            }
                        });
                    }
                    
                    // コンテンツから修理手順セクションを抽出（改良版）
                    if (result.content && result.content.includes('修理手順')) {
                        console.log('✅ コンテンツから修理手順を抽出中...');
                        const content = result.content;
                        
                        // 複数のパターンで修理手順を検索
                        const patterns = [
                            /## 修理手順\s*\n(.*?)(?=\n##|\n⚠️|\n\*\*|$)/s,
                            /修理手順\s*\n(.*?)(?=\n##|\n⚠️|\n\*\*|$)/s,
                            /詳細修理手順\s*\n(.*?)(?=\n##|\n⚠️|\n\*\*|$)/s
                        ];
                        
                        for (const pattern of patterns) {
                            const stepSectionMatch = content.match(pattern);
                            if (stepSectionMatch) {
                                console.log('✅ 修理手順セクションを発見');
                                const stepSection = stepSectionMatch[1];
                                const stepLines = stepSection.split('\n');
                                stepLines.forEach(line => {
                                    if (line.trim() && !line.startsWith('---')) {
                                        steps.push(`<div class="step-item">${line.trim()}</div>`);
                                    }
                                });
                                break;
                            }
                        }
                    }
                });
            }
            
            // 重複を除去
            const uniqueSteps = [...new Set(steps)];
            
            console.log('🔧 抽出された修理手順:', uniqueSteps.length, '件');
            if (uniqueSteps.length > 0) {
                console.log('🔧 修理手順の内容:', uniqueSteps);
            }
            
            return uniqueSteps.length > 0 ? uniqueSteps.join('') : '<div class="no-steps">修理手順の情報がありません</div>';
        }

        // 注意事項を取得（改良版）
        function getWarnings(results, query) {
            const warnings = [];
            
            // デバッグ用ログ
            console.log('⚠️ getWarnings デバッグ:', {
                results: results,
                results_length: Array.isArray(results) ? results.length : 'not array'
            });
            
            // results配列から注意事項を抽出
            if (Array.isArray(results)) {
                results.forEach(result => {
                    console.log('🔍 処理中の結果（注意事項）:', {
                        title: result.title,
                        category: result.category,
                        warnings: result.warnings,
                        content: result.content ? result.content.substring(0, 100) + '...' : 'なし'
                    });
                    
                    // 構造化されたデータから注意事項を抽出
                    if (result.warnings && Array.isArray(result.warnings)) {
                        console.log('✅ 配列形式の注意事項を発見:', result.warnings.length, '件');
                        result.warnings.forEach(warning => {
                            if (warning.trim()) {
                                warnings.push(`<div class="warning-item">${warning.trim()}</div>`);
                            }
                        });
                    } else if (result.warnings && typeof result.warnings === 'string') {
                        console.log('✅ 文字列形式の注意事項を発見');
                        const warningLines = result.warnings.split('\n');
                        warningLines.forEach(line => {
                            if (line.trim()) {
                                warnings.push(`<div class="warning-item">${line.trim()}</div>`);
                            }
                        });
                    }
                    
                    // コンテンツから注意事項セクションを抽出（改良版）
                    if (result.content && result.content.includes('注意事項')) {
                        console.log('✅ コンテンツから注意事項を抽出中...');
                        const content = result.content;
                        
                        // 複数のパターンで注意事項を検索
                        const patterns = [
                            /## 注意事項\s*\n(.*?)(?=\n##|\n\*\*|$)/s,
                            /⚠️ 注意事項\s*\n(.*?)(?=\n##|\n\*\*|$)/s,
                            /注意事項\s*\n(.*?)(?=\n##|\n\*\*|$)/s,
                            /安全上の注意事項\s*\n(.*?)(?=\n##|\n\*\*|$)/s
                        ];
                        
                        for (const pattern of patterns) {
                            const warningSectionMatch = content.match(pattern);
                            if (warningSectionMatch) {
                                console.log('✅ 注意事項セクションを発見');
                                const warningSection = warningSectionMatch[1];
                                const warningLines = warningSection.split('\n');
                                warningLines.forEach(line => {
                                    if (line.trim() && !line.startsWith('---')) {
                                        warnings.push(`<div class="warning-item">${line.trim()}</div>`);
                                    }
                                });
                                break;
                            }
                        }
                    }
                });
            }
            
            // 重複を除去
            const uniqueWarnings = [...new Set(warnings)];
            
            console.log('⚠️ 抽出された注意事項:', uniqueWarnings.length, '件');
            if (uniqueWarnings.length > 0) {
                console.log('⚠️ 注意事項の内容:', uniqueWarnings);
            }
            
            return uniqueWarnings.length > 0 ? uniqueWarnings.join('') : '<div class="no-warnings">注意事項の情報がありません</div>';
        }

        // 修理費用目安を取得
        function getRepairCosts(result, query) {
            const costs = [];
            
            // 詳細デバッグ用ログ
            console.log('🔍 getRepairCosts 詳細デバッグ:');
            console.log('  - result:', result);
            console.log('  - result.repair_costs:', result.repair_costs);
            console.log('  - result.costs:', result.costs);
            console.log('  - result.category:', result.category);
            console.log('  - typeof result.costs:', typeof result.costs);
            console.log('  - Array.isArray(result.costs):', Array.isArray(result.costs));
            
            // 構造化されたデータから修理費用を抽出
            if (result.repair_costs) {
                const costLines = result.repair_costs.split('\n');
                costLines.forEach(line => {
                    if (line.trim() && line.includes('円')) {
                        costs.push(`<div class="cost-item">${line.trim()}</div>`);
                    }
                });
            }
            
            // 従来のcostsフィールドからも抽出（配列と文字列の両方に対応）
            if (result.costs) {
                console.log('💰 costsフィールドが見つかりました:', result.costs);
                if (Array.isArray(result.costs)) {
                    console.log('💰 配列として処理します');
                    // 配列の場合
                    result.costs.forEach((cost, index) => {
                        console.log(`  [${index}] 費用項目:`, cost);
                        if (cost && cost.includes('円')) {
                            const costHtml = `<div class="cost-item">${cost}</div>`;
                            costs.push(costHtml);
                            console.log('  ✅ 費用項目を追加:', costHtml);
                        }
                    });
                } else {
                    console.log('💰 文字列として処理します');
                    // 文字列の場合
                    const costLines = result.costs.split('\n');
                    costLines.forEach((line, index) => {
                        console.log(`  [${index}] 行:`, line);
                        if (line.trim() && line.includes('円')) {
                            const costHtml = `<div class="cost-item">${line.trim()}</div>`;
                            costs.push(costHtml);
                            console.log('  ✅ 費用項目を追加:', costHtml);
                        }
                    });
                }
            } else {
                console.log('💰 costsフィールドが見つかりません');
            }
            
            // コンテンツから修理費用目安セクションを抽出
            if (result.content && result.content.includes('修理費用目安')) {
                const content = result.content;
                const costSectionMatch = content.match(/## 修理費用目安\s*\n(.*?)(?=\n##|\n\*\*|$)/s);
                if (costSectionMatch) {
                    const costSection = costSectionMatch[1];
                    const costLines = costSection.split('\n');
                    costLines.forEach(line => {
                        if (line.trim() && line.includes('円')) {
                            costs.push(`<div class="cost-item">${line.trim()}</div>`);
                        }
                    });
                }
            }
            
            // 構造化されたコンテンツからも抽出
            if (result.structured_content && result.structured_content.repair_costs) {
                result.structured_content.repair_costs.forEach(cost => {
                    costs.push(`<div class="cost-item">• ${cost}</div>`);
                });
            }
            
            // 重複を除去
            const uniqueCosts = [...new Set(costs)];
            
            console.log('💰 抽出された修理費用:', uniqueCosts.length, '件');
            
            // 費用情報が全くない場合のフォールバック
            if (uniqueCosts.length === 0) {
                console.log('💰 費用情報が見つからないため、フォールバック処理を実行');
                console.log('💰 カテゴリ:', result.category);
                
                // カテゴリに基づくデフォルト費用情報
                if (result.category === 'バッテリー') {
                    console.log('💰 バッテリーのデフォルト費用を返します');
                    return `<div class="cost-item">バッテリー交換: 15,000-30,000円</div>
                           <div class="cost-item">端子清掃: 無料（自分で作業）</div>
                           <div class="cost-item">充電器交換: 5,000-15,000円</div>`;
                } else if (result.category === 'トイレ') {
                    console.log('💰 トイレのデフォルト費用を返します');
                    return `<div class="cost-item">カセットタンク交換: 8,000-15,000円</div>
                           <div class="cost-item">パッキン交換: 2,000-5,000円</div>
                           <div class="cost-item">バルブ交換: 5,000-10,000円</div>`;
                } else if (result.category === 'エアコン') {
                    console.log('💰 エアコンのデフォルト費用を返します');
                    return `<div class="cost-item">フィルター交換: 3,000-8,000円</div>
                           <div class="cost-item">冷媒ガス補充: 10,000-20,000円</div>
                           <div class="cost-item">コンプレッサー交換: 50,000-100,000円</div>`;
                } else if (result.category === '雨漏り') {
                    console.log('💰 雨漏りのデフォルト費用を返します');
                    return `<div class="cost-item">シーリング材: 1,000-3,000円</div>
                           <div class="cost-item">防水テープ: 2,000-5,000円</div>
                           <div class="cost-item">専門業者修理: 20,000-50,000円</div>`;
                } else {
                    console.log('💰 カテゴリが不明なため、一般的なメッセージを返します');
                    return '<div class="no-costs">修理費用目安の情報がありません。専門業者にご相談ください。</div>';
                }
            }
            
            return uniqueCosts.join('');
        }

        // 必要な工具・部品を取得（改善版 - エアコン対応）
        function getToolsAndParts(result, query) {
            const tools = [];
            
            // 構造化されたデータから工具を抽出
            if (result.structured_content && result.structured_content.tools_needed) {
                result.structured_content.tools_needed.forEach(tool => {
                    tools.push(`<div class="tool-item">• ${tool}</div>`);
                });
            }
            
            // 推奨製品から工具を抽出
            if (result.recommended_products && result.recommended_products.items) {
                result.recommended_products.items.forEach(product => {
                    tools.push(`<div class="tool-item">• ${product}</div>`);
                });
            }
            
            // エアコン専用の工具・部品情報抽出
            if (result.content && result.content.includes('エアコン')) {
                const content = result.content;
                
                // エアコン特有の工具・部品
                if (content.includes('電圧計')) {
                    tools.push('<div class="tool-item">• 電圧計（12V測定用）</div>');
                }
                if (content.includes('ドライバー')) {
                    tools.push('<div class="tool-item">• ドライバーセット</div>');
                }
                if (content.includes('ヒューズ')) {
                    tools.push('<div class="tool-item">• ヒューズ類（各種容量）</div>');
                }
                if (content.includes('冷媒ガス')) {
                    tools.push('<div class="tool-item">• 冷媒ガス缶・チャージツール</div>');
                }
                if (content.includes('シーリング材')) {
                    tools.push('<div class="tool-item">• シーリング材・パッキン類</div>');
                }
                if (content.includes('清掃用具')) {
                    tools.push('<div class="tool-item">• 清掃用具（ブラシ等）</div>');
                }
                
                // エアコン特有の部品
                if (content.includes('コンプレッサー')) {
                    tools.push('<div class="tool-item">• コンプレッサー部品</div>');
                }
                if (content.includes('ファンモーター')) {
                    tools.push('<div class="tool-item">• ファンモーター部品</div>');
                }
                if (content.includes('リモコン')) {
                    tools.push('<div class="tool-item">• リモコン・受光部</div>');
                }
                if (content.includes('ドレンホース')) {
                    tools.push('<div class="tool-item">• ドレンホース・ドレンパン</div>');
                }
                if (content.includes('温度センサー')) {
                    tools.push('<div class="tool-item">• 温度センサー</div>');
                }
                if (content.includes('制御基板')) {
                    tools.push('<div class="tool-item">• 制御基板・電子部品</div>');
                }
            }
            
            // 一般的なコンテンツから工具情報を抽出
            if (result.content && !result.content.includes('エアコン')) {
                const content = result.content;
                const toolKeywords = ['レンチ', 'ドライバー', 'スパナ', 'メーター', 'テスター', '工具', '部品'];
                toolKeywords.forEach(keyword => {
                    if (content.includes(keyword)) {
                        tools.push(`<div class="tool-item">• ${keyword}関連</div>`);
                    }
                });
            }
            
            if (tools.length === 0) {
                tools.push('<div class="tool-item">• 基本的な工具セット</div>');
            }
            
            return tools.join('');
        }

        // モックデータ（APIが利用できない場合のフォールバック）
        function getMockResults(query) {
            console.log('📋 モックデータ生成中:', query);
            
            const mockResults = [
                {
                    title: "バッテリー修理アドバイス",
                    category: "バッテリー",
                    filename: "バッテリー.txt",
                    content: "バッテリーの寿命は通常2-3年です。定期的な点検と適切な充電管理が重要です。電圧チェック（12.6V以上が正常）と端子の清掃を定期的に行いましょう。",
                    costs: ["15,000円", "25,000円", "35,000円"],
                    alternatives: ["【バッテリーA型】", "【バッテリーB型】", "【バッテリーC型】"],
                    urls: ["https://example.com/battery1", "https://example.com/battery2"],
                    summary: "バッテリーの基本的なメンテナンスと交換について",
                    structured_content: {
                        problem_description: "バッテリーの調子が悪い、エンジンがかからない、電圧が低いなどの症状",
                        causes: ["バッテリーの寿命", "端子の腐食", "充電不足", "過放電"],
                        solutions: ["端子の清掃", "充電器での充電", "バッテリーの交換", "充電システムの点検"],
                        tools_needed: ["マルチメーター", "端子ブラシ", "充電器", "レンチセット"]
                    },
                    warnings: ["バッテリー液は危険です", "充電中は換気を十分に", "専門知識が必要な場合は専門店に相談"],
                    repair_costs: {
                        summary: "15,000円～35,000円",
                        items: ["バッテリー交換: 15,000円～25,000円", "端子清掃: 3,000円～5,000円", "充電システム点検: 5,000円～10,000円"]
                    },
                    recommended_products: {
                        items: ["ディープサイクルバッテリー", "バッテリーチャージャー", "端子クリーナー"]
                    }
                },
                {
                    title: "雨漏り修理アドバイス",
                    category: "雨漏り",
                    filename: "雨漏り.txt",
                    content: "雨漏りの原因は主にシーリング材の劣化です。早期発見と適切な補修が重要です。防水テープでの応急処置も可能です。",
                    costs: ["8,000円", "15,000円", "30,000円"],
                    alternatives: ["【シーリング材A】", "【シーリング材B】"],
                    urls: ["https://example.com/sealing1"],
                    summary: "雨漏りの原因特定と修理方法について",
                    structured_content: {
                        problem_description: "天井や壁から水が漏れる、カビが発生する、内装材が濡れる",
                        causes: ["シーリング材の劣化", "屋根の破損", "窓枠の隙間", "配管の破損"],
                        solutions: ["シーリング材の交換", "防水テープでの応急処置", "屋根の補修", "配管の修理"],
                        tools_needed: ["シーリングガン", "防水テープ", "カッター", "ブラシ"]
                    },
                    warnings: ["高所での作業は危険", "適切な保護具を着用", "専門業者への相談を推奨"],
                    repair_costs: {
                        summary: "8,000円～30,000円",
                        items: ["シーリング材交換: 8,000円～15,000円", "屋根補修: 20,000円～50,000円", "配管修理: 10,000円～25,000円"]
                    },
                    recommended_products: {
                        items: ["ウレタンシーリング", "防水テープ", "屋根用コーキング"]
                    }
                },
                {
                    title: "エアコン修理アドバイス",
                    category: "エアコン",
                    filename: "エアコン.txt",
                    content: "エアコンのフィルター清掃と冷媒ガスの点検が重要です。室外機の清掃も定期的に行いましょう。",
                    costs: ["12,000円", "20,000円", "45,000円"],
                    alternatives: ["【エアコンフィルターA】", "【冷媒ガスB】"],
                    urls: ["https://example.com/aircon1"],
                    summary: "エアコンのメンテナンスと修理について",
                    structured_content: {
                        problem_description: "冷えない、異音がする、水が漏れる、フィルターが汚れている",
                        causes: ["フィルターの汚れ", "冷媒ガス不足", "室外機の汚れ", "電気系統の故障"],
                        solutions: ["フィルターの清掃", "冷媒ガスの補充", "室外機の清掃", "電気系統の点検"],
                        tools_needed: ["フィルタークリーナー", "ブラシ", "マルチメーター", "圧力計"]
                    },
                    warnings: ["冷媒ガスは専門知識が必要", "電気系統の作業は感電の危険", "室外機の清掃は安全に"],
                    repair_costs: {
                        summary: "12,000円～45,000円",
                        items: ["フィルター交換: 3,000円～8,000円", "冷媒ガス補充: 15,000円～25,000円", "室外機清掃: 5,000円～10,000円"]
                    },
                    recommended_products: {
                        items: ["エアコンフィルター", "冷媒ガス", "フィルタークリーナー"]
                    }
                },
                {
                    title: "トイレ修理アドバイス",
                    category: "トイレ",
                    filename: "トイレ.txt",
                    content: "キャンピングカーのトイレは定期的な清掃とメンテナンスが重要です。カセットタンクの交換やポンプの点検を行いましょう。",
                    costs: ["5,000円", "15,000円", "25,000円"],
                    alternatives: ["【カセットタンク】", "【ポンプ】", "【シール】"],
                    urls: ["https://example.com/toilet1"],
                    summary: "キャンピングカートイレのメンテナンスと修理について",
                    structured_content: {
                        problem_description: "水が流れない、異臭がする、水漏れが発生する、ポンプが動かない",
                        causes: ["カセットタンクの汚れ", "ポンプの故障", "シールの劣化", "配管の詰まり"],
                        solutions: ["カセットタンクの清掃", "ポンプの点検", "シールの交換", "配管の清掃"],
                        tools_needed: ["ブラシ", "洗剤", "シール", "ポンプ"]
                    },
                    warnings: ["汚物の処理は適切に", "清掃時は手袋を着用", "シール交換は慎重に"],
                    repair_costs: {
                        summary: "5,000円～25,000円",
                        items: ["カセットタンク交換: 8,000円～15,000円", "ポンプ交換: 12,000円～20,000円", "シール交換: 3,000円～8,000円"]
                    },
                    recommended_products: {
                        items: ["カセットタンク", "トイレポンプ", "シールキット", "トイレ洗剤"]
                    }
                }
            ];
            
            // クエリに基づいて関連する結果をフィルタリング
            const queryLower = query.toLowerCase();
            const filteredResults = mockResults.filter(result => {
                const categoryMatch = result.category.toLowerCase().includes(queryLower);
                const contentMatch = result.content.toLowerCase().includes(queryLower);
                const titleMatch = result.title.toLowerCase().includes(queryLower);
                const summaryMatch = result.summary && result.summary.toLowerCase().includes(queryLower);
                
                return categoryMatch || contentMatch || titleMatch || summaryMatch;
            });
            
            console.log('✅ フィルタリング結果:', filteredResults.length, '件');
            return filteredResults;
        }

        // 結果表示（改善版）
        function displayResults(results, query) {
            console.log('📊 結果表示開始:', results.length, '件');
            console.log('📊 結果詳細:', JSON.stringify(results, null, 2));
            
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsSection = document.getElementById('resultsSection');
            
            console.log('🔍 DOM要素チェック:');
            console.log('  - resultsContainer:', resultsContainer);
            console.log('  - resultsSection:', resultsSection);
            
            if (!resultsContainer) {
                console.error('❌ resultsContainerが見つかりません');
                return;
            }
            
            if (!resultsSection) {
                console.error('❌ resultsSectionが見つかりません');
                return;
            }
            
            if (!results || results.length === 0) {
                console.log('⚠️ 結果がありません - 結果セクションを非表示にします');
                // 結果セクションを非表示にする
                resultsSection.classList.remove('show');
                return;
            }
            
            console.log('✅ 結果を表示中...');
            resultsContainer.innerHTML = '';
            
            // 結果セクションを表示
            resultsSection.classList.add('show');
            
            // 検索情報の表示（改良版）
            const searchInfo = createSearchInfo(results, query);
            if (results.length === 1) {
                searchInfo.classList.add('single-result');
            }
            resultsContainer.appendChild(searchInfo);
            
            // フォールバック提案の場合は特別な表示（削除）
            
            // 結果の表示（マニュアル除外版）
            results.forEach((result, index) => {
                console.log('📝 結果要素作成中:', index + 1, result.title);
                console.log('📝 結果データ:', result);
                
                // マニュアル関連の結果を除外
                if (result.source === 'manual' || result.category === 'マニュアル' || 
                    result.title?.includes('マニュアル') || result.title?.includes('manual')) {
                    console.log('🚫 マニュアル結果を除外:', result.title);
                    return; // この結果をスキップ
                }
                
                // 簡易版の結果表示を作成
                const resultElement = document.createElement('div');
                resultElement.className = 'result-item fade-in';
                console.log('📝 結果要素のHTMLを生成中...');
                resultElement.innerHTML = `
                    <div class="result-header">
                        <h3>${result.title || 'タイトルなし'}</h3>
                        <span class="relevance-badge">${result.relevance || 'medium'}</span>
                    </div>
                    <div class="result-content">
                        <p><strong>カテゴリー:</strong> ${result.category || 'N/A'}</p>
                        <p><strong>ソース:</strong> ${result.source || 'N/A'}</p>
                        <p><strong>内容:</strong> ${result.content || result.text || '内容なし'}</p>
                        ${result.repair_steps && result.repair_steps.length > 0 ? `
                            <div class="repair-steps">
                                <h4>🔧 修理手順:</h4>
                                <ul>
                                    ${result.repair_steps.map(step => `<li>${step}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${result.costs && result.costs.length > 0 ? `
                            <div class="repair-costs">
                                <h4>💰 修理費用目安:</h4>
                                ${(() => {
                                    console.log('💰 修理費用目安セクションを生成中...');
                                    const costHtml = getRepairCosts(result, query);
                                    console.log('💰 生成された費用HTML:', costHtml);
                                    return costHtml;
                                })()}
                            </div>
                        ` : ''}
                        ${result.warnings && result.warnings.length > 0 ? `
                            <div class="warnings">
                                <h4>⚠️ 注意事項:</h4>
                                <ul>
                                    ${result.warnings.map(warning => `<li>${warning}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                if (results.length === 1) {
                    resultElement.classList.add('single-result');
                }
                
                console.log('📝 結果要素をDOMに追加中...');
                console.log('📝 結果要素の内容:', resultElement.innerHTML.substring(0, 500) + '...');
                resultsContainer.appendChild(resultElement);
                console.log('✅ 結果要素をDOMに追加完了');
            });
            
            // 代替品セクションを常に表示
            const alternativeSection = document.createElement('div');
            alternativeSection.className = 'result-item fade-in';
            alternativeSection.innerHTML = `
                <div class="result-header">
                    <h3>🛒 代替品の紹介</h3>
                    <span class="relevance-badge">推奨</span>
                </div>
                <div class="result-content">
                    ${generateDynamicProducts(query)}
                </div>
            `;
            resultsContainer.appendChild(alternativeSection);
            
            // 岡山キャンピングカー修理サポートセンターセクションを常に表示
            const supportCenterSection = document.createElement('div');
            supportCenterSection.className = 'result-item support-center-section fade-in';
            supportCenterSection.innerHTML = `
                <div class="result-header">
                    <h3>🏢 岡山キャンピングカー修理サポートセンター</h3>
                    <span class="relevance-badge">専門サポート</span>
                </div>
                <div class="result-content">
                    <div class="support-center-info">
                        <div class="contact-box">
                            <div class="contact-item">
                                <span class="contact-icon">📍</span>
                                <span class="contact-label">住所:</span>
                                <span class="contact-value">〒700-0921 岡山市北区東古松485-4 2F</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">📞</span>
                                <span class="contact-label">電話:</span>
                                <span class="contact-value">086-206-6622</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">📧</span>
                                <span class="contact-label">お問合わせ:</span>
                                <span class="contact-value"><a href="https://camper-repair.net/contact/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/contact/</a></span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">🌐</span>
                                <span class="contact-label">ホームページ:</span>
                                <span class="contact-value"><a href="https://camper-repair.net/blog/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/blog/</a></span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">⏰</span>
                                <span class="contact-label">営業時間:</span>
                                <span class="contact-value">年中無休（9:00～21:00）</span>
                            </div>
                            <div class="contact-note">
                                ※不在時は折り返しお電話差し上げます。
                            </div>
                            <div class="company-info">
                                （運営）株式会社リクエストプラス
                            </div>
                        </div>
                        
                        <div class="service-box">
                            <h6>🔧 対応サービス:</h6>
                            <ul class="service-list">
                                <li>バッテリー・インバーター修理・交換</li>
                                <li>電気配線・電装系トラブル対応</li>
                                <li>雨漏り・防水工事</li>
                                <li>各種家電・設備の修理</li>
                                <li>定期点検・メンテナンス</li>
                                <li>緊急対応・出張修理（要相談）</li>
                            </ul>
                        </div>
                        
                        <div class="consultation-box">
                            <h6>💡 ご相談の際は:</h6>
                            <ul class="consultation-list">
                                <li>車種・年式</li>
                                <li>症状の詳細</li>
                                <li>希望する対応方法</li>
                            </ul>
                            <p class="consultation-note">をお教えください。</p>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(supportCenterSection);
            
            console.log('🎯 結果セクションを表示中...');
            resultsSection.classList.add('show');
            console.log('🎉 結果表示完了');
        }

        // 検索情報の表示
        function createSearchInfo(results, query) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'search-info';
            
            let resultText = '';
            if (results.length === 1) {
                resultText = '<p><strong>最も関連性の高い結果:</strong> 1件</p>';
            } else {
                resultText = `<p><strong>見つかった結果:</strong> ${results.length}件</p>`;
            }
            
            infoDiv.innerHTML = `
                <div class="search-summary">
                    <h3>🔍 検索結果</h3>
                    <p><strong>検索クエリ:</strong> "${query}"</p>
                    ${resultText}
                </div>
            `;
            return infoDiv;
        }

        // フォーマットされた結果要素の作成（改善版 - キーワードマッチング対応）
        function createFormattedResultElement(result, index, query, results) {
            const div = document.createElement('div');
            
            // 費用目安情報の場合は特別なクラスを適用
            if (result.source === 'cost_info' || result.category === '費用情報') {
                div.className = `result-item cost-info fade-in ${result.relevance || 'medium'}`;
            } else {
                div.className = `result-item fade-in ${result.relevance || 'medium'}`;
            }
            
            // 関連度レベルに基づくスタイル
            const relevanceIcon = getRelevanceIcon(result.relevance);
            const sourceIcon = getSourceIcon(result.source);
            
            // キーワードマッチングの改善
            const highlightedContent = highlightKeywords(result.content || result.text || '', query);
            const highlightedTitle = highlightKeywords(result.title || '', query);
            
            // 費用目安情報の場合は特別なフォーマット
            let formattedContent = highlightedContent;
            if (result.source === 'cost_info' || result.category === '費用情報') {
                formattedContent = formatCostInformation(highlightedContent);
            }
            
            div.innerHTML = `
                <div class="result-header">
                    <div class="result-rank">
                        <span class="rank-number">${index + 1}</span>
                        <span class="relevance-icon">${relevanceIcon}</span>
                    </div>
                    <div class="result-title-section">
                        <h3 class="result-title">${highlightedTitle}</h3>
                        <div class="result-meta">
                            <span class="category">📂 ${result.category || result.filename || 'その他'}</span>
                            <span class="source">${sourceIcon} ${getSourceName(result.source)}</span>
                        </div>
                    </div>
                </div>
                
                    <div class="result-content">
                        <div class="problem-header">
                            <div class="problem-icon">🔧</div>
                            <div class="problem-title">${highlightedTitle}</div>
                        </div>
                        
                        <!-- 費用目安情報の特別表示 -->
                        ${result.source === 'cost_info' || result.category === '費用情報' ? 
                            `<div class="cost-details">${formattedContent}</div>` : 
                            `<div class="result-text">${formattedContent}</div>`
                        }
                    
                    <!-- 整理された情報セクション -->
                    <div class="organized-sections">
                        <!-- 1. 問題の種類（非表示） -->
                        <!--
                        <div class="section-item">
                            <h4 class="section-title">🔍 問題の種類</h4>
                            <div class="section-content">
                                ${getProblemTypes(result, query)}
                            </div>
                        </div>
                        -->
                        
                        <!-- 2. 修理費用目安 -->
                        <div class="section-item">
                            <h4 class="section-title">💰 修理費用目安</h4>
                            <div class="section-content">
                                ${(() => {
                                    console.log('💰 修理費用目安セクションを生成中...');
                                    const costHtml = getRepairCosts(result, query);
                                    console.log('💰 生成された費用HTML:', costHtml);
                                    return costHtml;
                                })()}
                            </div>
                        </div>
                        
                        <!-- 3. 必要な工具・部品（非表示） -->
                        <!--
                        <div class="section-item">
                            <h4 class="section-title">🛠️ 必要な工具・部品</h4>
                            <div class="section-content">
                                ${getToolsAndParts(result, query)}
                            </div>
                        </div>
                        -->
                        
                        <!-- 4. 修理手順 -->
                        <div class="section-item">
                            <h4 class="section-title">🔧 修理手順</h4>
                            <div class="section-content">
                                ${getRepairStepsFromResult(result, query)}
                            </div>
                        </div>
                        
                        <!-- 5. 注意事項 -->
                        <div class="section-item">
                            <h4 class="section-title">⚠️ 注意事項</h4>
                            <div class="section-content">
                                ${getWarningsFromResult(result, query)}
                            </div>
                        </div>
                        
                        <!-- 6. 代替品の紹介（動的生成） -->
                        <div class="section-item">
                            <h4 class="section-title">🛒 代替品の紹介</h4>
                            <div class="section-content">
                                ${generateDynamicProducts(query)}
                            </div>
                        </div>
                        
                        <!-- 7. 岡山キャンピングカー修理サポートセンター -->
                        <div class="section-item support-center-section">
                            <div class="section-number">7</div>
                            <div class="section-content">
                                <h4>🏢 岡山キャンピングカー修理サポートセンター</h4>
                                <div class="support-center-info">
                                    <div class="contact-box">
                                        <div class="contact-item">
                                            <span class="contact-icon">📍</span>
                                            <span class="contact-label">住所:</span>
                                            <span class="contact-value">〒700-0921 岡山市北区東古松485-4 2F</span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">📞</span>
                                            <span class="contact-label">電話:</span>
                                            <span class="contact-value">086-206-6622</span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">📧</span>
                                            <span class="contact-label">お問合わせ:</span>
                                            <span class="contact-value"><a href="https://camper-repair.net/contact/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/contact/</a></span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">🌐</span>
                                            <span class="contact-label">ホームページ:</span>
                                            <span class="contact-value"><a href="https://camper-repair.net/blog/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/blog/</a></span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">⏰</span>
                                            <span class="contact-label">営業時間:</span>
                                            <span class="contact-value">年中無休（9:00～21:00）</span>
                                        </div>
                                        <div class="contact-note">
                                            ※不在時は折り返しお電話差し上げます。
                                        </div>
                                        <div class="company-info">
                                            （運営）株式会社リクエストプラス
                                        </div>
                                    </div>
                                    
                                    <div class="service-box">
                                        <h6>🔧 対応サービス:</h6>
                                        <ul class="service-list">
                                            <li>バッテリー・インバーター修理・交換</li>
                                            <li>電気配線・電装系トラブル対応</li>
                                            <li>雨漏り・防水工事</li>
                                            <li>各種家電・設備の修理</li>
                                            <li>定期点検・メンテナンス</li>
                                            <li>緊急対応・出張修理（要相談）</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="consultation-box">
                                        <h6>💡 ご相談の際は:</h6>
                                        <ul class="consultation-list">
                                            <li>車種・年式</li>
                                            <li>症状の詳細</li>
                                            <li>希望する対応方法</li>
                                        </ul>
                                        <p class="consultation-note">をお教えください。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="quick-info">
                        ${result.costs || result.repair_costs ? `
                        <div class="quick-cost">
                            <h4>💰 修理費用目安</h4>
                            <p class="cost-highlight">${result.costs || result.repair_costs}</p>
                        </div>
                        ` : ''}
                        
                        ${result.tools || result.parts ? `
                        <div class="quick-products">
                            <h4>🛠️ 必要な工具・部品</h4>
                            <div class="product-tags">
                                ${result.tools ? `<span class="product-tag">工具: ${result.tools}</span>` : ''}
                                ${result.parts ? `<span class="product-tag">部品: ${result.parts}</span>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="troubleshooting-sections">
                        ${result.structured_content?.problem_description ? `
                        <div class="section-item">
                            <div class="section-number">1</div>
                            <div class="section-content">
                                <h4>問題の詳細な状況を確認</h4>
                                <p>${result.structured_content.problem_description}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.warnings?.length > 0 ? `
                        <div class="section-item safety-section">
                            <div class="section-number">2</div>
                            <div class="section-content">
                                <h4>安全上の注意点</h4>
                                <div class="safety-warnings">
                                    ${result.warnings.map(warning => `
                                        <div class="safety-item">
                                            <span class="safety-icon">⚠️</span>
                                            <span class="safety-text">${warning}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.structured_content?.causes?.length > 0 ? `
                        <div class="section-item">
                            <div class="section-number">3</div>
                            <div class="section-content">
                                <h4>考えられる原因</h4>
                                <ul class="cause-list">
                                    ${result.structured_content.causes.map(cause => `<li>${cause}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.structured_content?.solutions?.length > 0 ? `
                        <div class="section-item">
                            <div class="section-number">4</div>
                            <div class="section-content">
                                <h4>具体的な修理手順</h4>
                                ${result.category === 'トイレ' ? `
                                <div class="toilet-repair-advice">
                                    <div class="repair-step">
                                        <div class="step-header">
                                            <h5>🔧 カセットタンクの清掃とメンテナンス</h5>
                                            <div class="cost-badge">0円（自分で作業）</div>
                                        </div>
                                        <p class="cost-description">清掃用品のみ必要</p>
                                        <ul class="step-details">
                                            <li>カセットタンクを取り外し、中身を適切に処理する</li>
                                            <li>タンク内部をブラシと洗剤で清掃する</li>
                                            <li>水で十分にすすぎ、乾燥させる</li>
                                            <li>新しい薬剤を適量投入する</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="repair-step">
                                        <div class="step-header">
                                            <h5>🔧 ポンプの動作確認と清掃</h5>
                                            <div class="cost-badge">3,000円～8,000円</div>
                                        </div>
                                        <p class="cost-description">ポンプ清掃・部品交換費用</p>
                                        <ul class="step-details">
                                            <li>ポンプの電源を確認し、動作テストを行う</li>
                                            <li>ポンプ内部の詰まりを確認し、清掃する</li>
                                            <li>配管の詰まりを確認し、必要に応じて清掃する</li>
                                            <li>ポンプの動作音を確認し、異常がないかチェックする</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="repair-step">
                                        <div class="step-header">
                                            <h5>🔧 シール・パッキンの点検と交換</h5>
                                            <div class="cost-badge">5,000円～15,000円</div>
                                        </div>
                                        <p class="cost-description">部品代＋工賃</p>
                                        <ul class="step-details">
                                            <li>シール・パッキンの劣化状況を確認する</li>
                                            <li>亀裂や硬化がないか点検する</li>
                                            <li>必要に応じて新しいシール・パッキンに交換する</li>
                                            <li>交換後は水漏れがないか確認する</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="repair-step">
                                        <div class="step-header">
                                            <h5>🔧 電源・配線の確認</h5>
                                            <div class="cost-badge">2,000円～10,000円</div>
                                        </div>
                                        <p class="cost-description">電気工事費用</p>
                                        <ul class="step-details">
                                            <li>電源スイッチの動作を確認する</li>
                                            <li>配線の断線や接触不良がないかチェックする</li>
                                            <li>ヒューズの状態を確認し、必要に応じて交換する</li>
                                            <li>電圧をマルチメーターで測定し、正常値を確認する</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="repair-step">
                                        <div class="step-header">
                                            <h5>🔧 水タンクの水量確認</h5>
                                            <div class="cost-badge">0円～3,000円</div>
                                        </div>
                                        <p class="cost-description">給水系統の点検・修理</p>
                                        <ul class="step-details">
                                            <li>水タンクの水量を確認し、不足している場合は補充する</li>
                                            <li>給水ポンプの動作を確認する</li>
                                            <li>給水管の詰まりがないかチェックする</li>
                                            <li>給水バルブの開閉を確認する</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="repair-step">
                                        <div class="step-header">
                                            <h5>🔧 異物の除去</h5>
                                            <div class="cost-badge">1,000円～5,000円</div>
                                        </div>
                                        <p class="cost-description">清掃・分解作業費用</p>
                                        <ul class="step-details">
                                            <li>異物の位置と種類を特定する</li>
                                            <li>安全に異物を取り除く</li>
                                            <li>影響を受けた部分を清掃する</li>
                                            <li>動作確認を行う</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="repair-step">
                                        <div class="step-header">
                                            <h5>🔧 薬剤の補充</h5>
                                            <div class="cost-badge">500円～2,000円</div>
                                        </div>
                                        <p class="cost-description">薬剤代のみ</p>
                                        <ul class="step-details">
                                            <li>適切な薬剤を選択する</li>
                                            <li>薬剤を適量投入する</li>
                                            <li>希釈倍率を確認する</li>
                                            <li>効果を確認する</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="repair-step">
                                        <div class="step-header">
                                            <h5>🔧 排水弁の動作確認</h5>
                                            <div class="cost-badge">3,000円～8,000円</div>
                                        </div>
                                        <p class="cost-description">弁の点検・交換費用</p>
                                        <ul class="step-details">
                                            <li>排水弁の動作を確認する</li>
                                            <li>弁の開閉状態をチェックする</li>
                                            <li>必要に応じて弁を清掃・交換する</li>
                                            <li>水漏れがないか確認する</li>
                                        </ul>
                                    </div>
                                </div>
                                ` : `
                                <ol class="solution-steps">
                                    ${result.structured_content.solutions.map(solution => `<li>${solution}</li>`).join('')}
                                </ol>
                                `}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.structured_content?.tools_needed?.length > 0 ? `
                        <div class="section-item">
                            <div class="section-number">5</div>
                            <div class="section-content">
                                <h4>必要な工具・部品</h4>
                                <div class="tools-list">
                                    ${result.structured_content.tools_needed.map(tool => `
                                        <div class="tool-item">
                                            <span class="tool-icon">🔧</span>
                                            <span class="tool-name">${tool}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- 代替品の紹介セクション -->
                        <div class="section-item alternative-products-section">
                            <div class="section-number">6</div>
                            <div class="section-content">
                                <h4>🛒 代替品の紹介</h4>
                                
                                <!-- 商品検索機能 -->
                                <div class="product-search-section">
                                    <div class="search-header">
                                        <h5>🔍 商品を検索</h5>
                                        <p>必要な部品や工具を検索してください</p>
                                    </div>
                                    <div class="search-controls">
                                        <input type="text" id="productSearchInput" placeholder="例: ウレタンシーラント、ブチルテープ、窓枠モール、ガスケットなど" class="search-input">
                                        <button onclick="searchProducts()" class="search-btn">検索</button>
                                    </div>
                                    <div class="search-categories">
                                        <button onclick="filterProducts('all')" class="category-btn active">すべて</button>
                                        <button onclick="filterProducts('sealing')" class="category-btn">シーリング・防水</button>
                                        <button onclick="filterProducts('roof')" class="category-btn">ルーフ・窓枠</button>
                                        <button onclick="filterProducts('gasket')" class="category-btn">ガスケット・シール</button>
                                        <button onclick="filterProducts('interior')" class="category-btn">内装・壁紙</button>
                                    </div>
                                </div>
                                
                                <div class="alternative-products" id="productResults">
                                    <!-- 動的に生成される商品カテゴリ -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 岡山キャンピングカー修理サポートセンター紹介 -->
                        <div class="section-item support-center-section">
                            <div class="section-number">7</div>
                            <div class="section-content">
                                <h4>🏢 岡山キャンピングカー修理サポートセンター</h4>
                                <div class="support-center-info">
                                    <div class="contact-box">
                                        <div class="contact-item">
                                            <span class="contact-icon">📍</span>
                                            <span class="contact-label">住所:</span>
                                            <span class="contact-value">〒700-0921 岡山市北区東古松485-4 2F</span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">📞</span>
                                            <span class="contact-label">電話:</span>
                                            <span class="contact-value">086-206-6622</span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">📧</span>
                                            <span class="contact-label">お問合わせ:</span>
                                            <span class="contact-value"><a href="https://camper-repair.net/contact/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/contact/</a></span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">🌐</span>
                                            <span class="contact-label">ホームページ:</span>
                                            <span class="contact-value"><a href="https://camper-repair.net/blog/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/blog/</a></span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">⏰</span>
                                            <span class="contact-label">営業時間:</span>
                                            <span class="contact-value">年中無休（9:00～21:00）</span>
                                        </div>
                                        <div class="contact-note">
                                            ※不在時は折り返しお電話差し上げます。
                                        </div>
                                        <div class="company-info">
                                            （運営）株式会社リクエストプラス
                                        </div>
                                    </div>
                                    
                                    <div class="service-box">
                                        <h6>🔧 対応サービス:</h6>
                                        <ul class="service-list">
                                            <li>バッテリー・インバーター修理・交換</li>
                                            <li>電気配線・電装系トラブル対応</li>
                                            <li>雨漏り・防水工事</li>
                                            <li>各種家電・設備の修理</li>
                                            <li>定期点検・メンテナンス</li>
                                            <li>緊急対応・出張修理（要相談）</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="consultation-box">
                                        <h6>💡 ご相談の際は:</h6>
                                        <ul class="consultation-list">
                                            <li>車種・年式</li>
                                            <li>症状の詳細</li>
                                            <li>希望する対応方法</li>
                                        </ul>
                                        <p class="consultation-note">をお教えください。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${result.repair_steps?.length > 0 ? `
                        <div class="section-item">
                            <div class="section-number">9</div>
                            <div class="section-content">
                                <h4>予防メンテナンスのアドバイス</h4>
                                <ul class="maintenance-list">
                                    ${result.repair_steps.map(step => `<li>${step}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.substitute_products?.length > 0 ? `
                        <div class="section-item substitute-section">
                            <div class="section-number">10</div>
                            <div class="section-content">
                                <h4>🔧 代用品・代替品の紹介</h4>
                                <div class="substitute-products">
                                    <p class="substitute-intro">壊れた際の代用品・代替品をご紹介します：</p>
                                    <div class="product-grid">
                                        ${result.substitute_products.map(product => `
                                            <div class="substitute-item">
                                                <div class="product-info">
                                                    <h6>${product.name}</h6>
                                                    ${product.url ? `
                                                        <a href="${product.url}" target="_blank" rel="noopener noreferrer" class="product-link">
                                                            🔗 詳細を見る
                                                        </a>
                                                    ` : ''}
                                                </div>
                                                <div class="product-type">
                                                    <span class="type-badge">代用品</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.part_purchase_info?.length > 0 ? `
                        <div class="section-item purchase-section">
                            <div class="section-number">${result.substitute_products?.length > 0 ? '11' : '10'}</div>
                            <div class="section-content">
                                <h4>🛒 部品購入情報</h4>
                                <div class="purchase-info">
                                    <p class="purchase-intro">修理に必要な部品の購入情報をご案内します：</p>
                                    <div class="part-grid">
                                        ${result.part_purchase_info.map(part => `
                                            <div class="part-item">
                                                <div class="part-info">
                                                    <h6>${part.name}</h6>
                                                    ${part.url ? `
                                                        <a href="${part.url}" target="_blank" rel="noopener noreferrer" class="part-link">
                                                            🛒 購入ページ
                                                        </a>
                                                    ` : `
                                                        <div class="part-search">
                                                            <span class="search-text">商品名で検索</span>
                                                        </div>
                                                    `}
                                                </div>
                                                <div class="part-type">
                                                    <span class="type-badge purchase">購入部品</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- 岡山キャンピングカー修理サポートセンター紹介 -->
                        <div class="section-item support-center-section">
                            <div class="section-number">7</div>
                            <div class="section-content">
                                <h4>🏢 岡山キャンピングカー修理サポートセンター</h4>
                                <div class="support-center-info">
                                    <div class="contact-box">
                                        <div class="contact-item">
                                            <span class="contact-icon">📍</span>
                                            <span class="contact-label">住所:</span>
                                            <span class="contact-value">〒700-0921 岡山市北区東古松485-4 2F</span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">📞</span>
                                            <span class="contact-label">電話:</span>
                                            <span class="contact-value">086-206-6622</span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">📧</span>
                                            <span class="contact-label">お問合わせ:</span>
                                            <span class="contact-value"><a href="https://camper-repair.net/contact/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/contact/</a></span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">🌐</span>
                                            <span class="contact-label">ホームページ:</span>
                                            <span class="contact-value"><a href="https://camper-repair.net/blog/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/blog/</a></span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">⏰</span>
                                            <span class="contact-label">営業時間:</span>
                                            <span class="contact-value">年中無休（9:00～21:00）</span>
                                        </div>
                                        <div class="contact-note">
                                            ※不在時は折り返しお電話差し上げます。
                                        </div>
                                        <div class="company-info">
                                            （運営）株式会社リクエストプラス
                                        </div>
                                    </div>
                                    
                                    <div class="service-box">
                                        <h6>🔧 対応サービス:</h6>
                                        <ul class="service-list">
                                            <li>バッテリー・インバーター修理・交換</li>
                                            <li>電気配線・電装系トラブル対応</li>
                                            <li>雨漏り・防水工事</li>
                                            <li>各種家電・設備の修理</li>
                                            <li>定期点検・メンテナンス</li>
                                            <li>緊急対応・出張修理（要相談）</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="consultation-box">
                                        <h6>💡 ご相談の際は:</h6>
                                        <ul class="consultation-list">
                                            <li>車種・年式</li>
                                            <li>症状の詳細</li>
                                            <li>希望する対応方法</li>
                                        </ul>
                                        <p class="consultation-note">をお教えください。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 専門家への相談タイミングセクションを削除 -->
                                
                                <div class="support-center-detailed">
                                    <h5>🏢 岡山キャンピングカー修理サポートセンター</h5>
                                    <p class="support-intro">専門的な修理やメンテナンスが必要な場合は、お気軽にご相談ください：</p>
                                    
                                    <div class="contact-details">
                                        <div class="contact-item">
                                            <span class="contact-icon">📍</span>
                                            <span class="contact-label">住所:</span>
                                            <span class="contact-value">〒700-0921 岡山市北区東古松485-4 2F</span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">📞</span>
                                            <span class="contact-label">電話:</span>
                                            <span class="contact-value">086-206-6622</span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">📧</span>
                                            <span class="contact-label">お問合わせ:</span>
                                            <span class="contact-value"><a href="https://camper-repair.net/contact/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/contact/</a></span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">🌐</span>
                                            <span class="contact-label">ホームページ:</span>
                                            <span class="contact-value"><a href="https://camper-repair.net/blog/" target="_blank" rel="noopener noreferrer">https://camper-repair.net/blog/</a></span>
                                        </div>
                                        <div class="contact-item">
                                            <span class="contact-icon">⏰</span>
                                            <span class="contact-label">営業時間:</span>
                                            <span class="contact-value">年中無休（9:00～21:00）</span>
                                        </div>
                                        <div class="contact-note">
                                            ※不在時は折り返しお電話差し上げます。
                                        </div>
                                        <div class="company-info">
                                            （運営）株式会社リクエストプラス
                                        </div>
                                    </div>
                                    
                                    <div class="service-list">
                                        <h6>🔧 対応サービス:</h6>
                                        <ul class="service-items">
                                            <li>バッテリー・インバーター修理・交換</li>
                                            <li>電気配線・電装系トラブル対応</li>
                                            <li>雨漏り・防水工事</li>
                                            <li>各種家電・設備の修理</li>
                                            <li>定期点検・メンテナンス</li>
                                            <li>緊急対応・出張修理（要相談）</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="consultation-info">
                                        <h6>💡 ご相談の際は:</h6>
                                        <ul class="consultation-items">
                                            <li>車種・年式</li>
                                            <li>症状の詳細</li>
                                            <li>希望する対応方法</li>
                                        </ul>
                                        <p class="consultation-note">をお教えください。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="support-center">
                        <h3>キャンピングカー修理サポートセンター</h3>
                        <div class="support-info">
                            <div class="contact-info">
                                <p><strong>📞 お電話でのご相談</strong></p>
                                <p>修理に関するご質問やご相談は、お気軽にお電話ください。</p>
                            </div>
                            <div class="contact-info">
                                <p><strong>🌐 オンラインサポート</strong></p>
                                <p>詳細な修理マニュアルや部品情報は、オンラインでご確認いただけます。</p>
                            </div>
                        </div>
                    </div>
                    
                    
                    ${result.repair_steps?.length > 0 ? `
                    <div class="repair-steps">
                        <h4>📝 修理手順</h4>
                        <ol class="steps-list">
                            ${result.repair_steps.map((step, idx) => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    ` : ''}
                    
                    ${result.warnings?.length > 0 ? `
                    <div class="warnings">
                        <h4>⚠️ 注意事項</h4>
                        <ul class="warnings-list">
                            ${result.warnings.map((warning, idx) => `<li>${warning}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <!-- 詳細セクションを非表示設定 -->
                    <!--
                    <div class="detailed-sections">
                        ${result.repair_costs?.items?.length > 0 ? `
                        <div class="collapsible-section">
                            <button class="section-header" onclick="toggleSection('costs${index}')">
                                <h4>💰 詳細な修理費用</h4>
                                <span class="toggle-icon">▼</span>
                            </button>
                            <div class="section-content" id="costs${index}" style="display: none;">
                                <p class="cost-summary">${result.repair_costs.summary}</p>
                                
                                ${result.repair_costs.detailed_breakdown?.length > 0 ? `
                                <div class="cost-breakdown">
                                    ${result.repair_costs.detailed_breakdown.map(cost => `
                                        <div class="cost-item">
                                            <div class="cost-header">
                                                ${cost.min_cost && cost.max_cost ? 
                                                    `<span class="cost-range">${cost.min_cost} - ${cost.max_cost}</span>` :
                                                    `<span class="cost-single">${cost.cost}</span>`
                                                }
                                            </div>
                                            <div class="cost-description">${cost.description}</div>
                                            ${cost.reason && cost.reason.length > 0 ? `
                                            <div class="cost-reason">
                                                <strong>根拠:</strong> ${cost.reason.join(', ')}
                                            </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                                
                                <ul class="cost-list">
                                    ${result.repair_costs.items.map(cost => `<li>${cost}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.recommended_products?.items?.length > 0 ? `
                        <div class="collapsible-section">
                            <button class="section-header" onclick="toggleSection('products${index}')">
                                <h4>🛠️ 詳細な推奨製品</h4>
                                <span class="toggle-icon">▼</span>
                            </button>
                            <div class="section-content" id="products${index}" style="display: none;">
                                ${result.recommended_products.detailed_products?.length > 0 ? `
                                <div class="product-details">
                                    ${result.recommended_products.detailed_products.map(product => `
                                        <div class="product-item">
                                            <strong>${product.name}</strong>
                                            <p>${product.description}</p>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                                
                                <ul class="product-list">
                                    ${result.recommended_products.items.map(product => `<li>${product}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.warnings?.length > 0 ? `
                        <div class="collapsible-section warning-section">
                            <button class="section-header" onclick="toggleSection('warnings${index}')">
                                <h4>⚠️ 重要な注意事項</h4>
                                <span class="toggle-icon">▼</span>
                            </button>
                            <div class="section-content" id="warnings${index}" style="display: none;">
                                <div class="warning-list">
                                    ${result.warnings.map(warning => `
                                        <div class="warning-item">
                                            <span class="warning-icon">⚠️</span>
                                            <span class="warning-text">${warning}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${result.related_links?.items?.length > 0 ? `
                        <div class="collapsible-section">
                            <button class="section-header" onclick="toggleSection('links${index}')">
                                <h4>🔗 関連リンク・参考資料</h4>
                                <span class="toggle-icon">▼</span>
                            </button>
                            <div class="section-content" id="links${index}" style="display: none;">
                                ${result.related_links.additional_resources?.length > 0 ? `
                                <div class="additional-resources">
                                    <h5>参考資料</h5>
                                    <ul class="resource-list">
                                        ${result.related_links.additional_resources.map(resource => `<li>${resource}</li>`).join('')}
                                    </ul>
                                </div>
                                ` : ''}
                                
                                <div class="link-list">
                                    ${result.related_links.items.map(url => `
                                        <a href="${url}" target="_blank" class="external-link">
                                            🔗 ${url}
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    -->
                    
                    <!-- 完全な内容表示と関連度詳細セクションを削除 -->
                </div>
                
                <div class="result-actions">
                    <button class="btn btn-primary" onclick="copyToClipboard('${result.title} - ${result.summary}')">
                        📋 この情報をコピー
                    </button>
                </div>
            `;
            
            return div;
        }

        // 関連度アイコンの取得
        function getRelevanceIcon(level) {
            const icons = {
                'high': '🔥',
                'medium': '⭐',
                'low': '📌',
                'very_low': '📝'
            };
            return icons[level] || '⭐';
        }

        // ソースアイコンの取得
        function getSourceIcon(source) {
            const icons = {
                'text_file': '📄',
                'notion': '📊',
                'rag_text': '🤖',
                'blog': '🔗',
                'fallback': '🔍'
            };
            return icons[source] || '📄';
        }

        // ソース名の取得
        function getSourceName(source) {
            const names = {
                'text_file': 'テキストファイル',
                'notion': 'Notionデータベース',
                'rag_text': 'RAG検索',
                'blog': 'ブログ記事',
                'fallback': '検索結果'
            };
            return names[source] || 'テキストファイル';
        }


        // 問題の種類を取得
        function getProblemTypes(result) {
            if (result.structured_content && result.structured_content.problem_description) {
                return `<p>${result.structured_content.problem_description}</p>`;
            } else if (result.content) {
                const content = result.content;
                if (content.includes('Case')) {
                    // ケース情報から問題を抽出
                    const cases = content.match(/## 【Case ([^】]+)】([^#]+)/g);
                    if (cases && cases.length > 0) {
                        let html = '<p><strong>主な問題パターン:</strong></p><ul>';
                        cases.slice(0, 3).forEach(caseText => {
                            const match = caseText.match(/## 【Case ([^】]+)】([^#]+)/);
                            if (match) {
                                html += `<li><strong>${match[1]}</strong>: ${match[2].trim().substring(0, 80)}...</li>`;
                            }
                        });
                        html += '</ul>';
                        return html;
                    }
                }
                return `<p>${content.substring(0, 200)}${content.length > 200 ? '...' : ''}</p>`;
            }
            return '<p>問題の詳細情報がありません。</p>';
        }

        // 削除された重複関数の内容は上記のgetRepairCosts関数に統合されました

        // 工具・部品を取得
        function getToolsAndParts(result) {
            const items = [];
            
            if (result.structured_content && result.structured_content.tools_needed) {
                items.push(...result.structured_content.tools_needed);
            }
            
            if (result.alternatives) {
                items.push(...result.alternatives);
            }
            
            if (result.recommended_products && result.recommended_products.items) {
                items.push(...result.recommended_products.items);
            }
            
            if (items.length > 0) {
                return '<ul>' + items.map(item => `<li>${item}</li>`).join('') + '</ul>';
            }
            
            // FFヒーターの場合の具体的な工具・部品情報
            if (result.content && (result.content.includes('FFヒーター') || result.content.includes('FF'))) {
                return `<ul>
                    <li><strong>工具:</strong> マルチメーター、ドライバーセット、ガス検知器</li>
                    <li><strong>FFヒーター部品:</strong> バーナー、制御基板、ファン、フィルター</li>
                    <li><strong>ガス系統:</strong> ガスホース、ガスバルブ、ガスレギュレーター</li>
                    <li><strong>電気系統:</strong> 配線、ヒューズ、リレー、スイッチ</li>
                    <li><strong>清掃用品:</strong> エアダスター、ブラシ、清掃剤</li>
                    <li><strong>安全用品:</strong> ガス検知器、換気扇、消火器</li>
                </ul>`;
            }
            // 雨漏りの場合の具体的な工具・部品情報
            else if (result.content && result.content.includes('雨漏り')) {
                return `<ul>
                    <li><strong>工具:</strong> シーリングガン、カッター、ブラシ、マスキングテープ</li>
                    <li><strong>シーリング材:</strong> ウレタンシーラント、ブチルテープ</li>
                    <li><strong>窓枠部品:</strong> モール、スポンジゴム、防水シール</li>
                    <li><strong>ルーフ部品:</strong> ルーフパネル、ジョイント材</li>
                    <li><strong>ガスケット:</strong> バックドア用、ランプ用</li>
                    <li><strong>内装材:</strong> 壁紙、内張り材</li>
                </ul>`;
            }
            
            return '<ul><li>基本的な工具セット</li><li>専門工具が必要な場合は専門店に相談</li></ul>';
        }

        // 修理手順を取得（改善版 - エアコン対応）
        function getRepairSteps(result) {
            if (result.structured_content && result.structured_content.solutions) {
                return '<ol>' + result.structured_content.solutions.map(solution => `<li>${solution}</li>`).join('') + '</ol>';
            } else if (result.repair_steps) {
                return '<ol>' + result.repair_steps.map(step => `<li>${step}</li>`).join('') + '</ol>';
            }
            
            // エアコン専用の修理手順
            if (result.content && result.content.includes('エアコン')) {
                return `<ol>
                    <li><strong>トラブル箇所の特定:</strong> 冷風の有無、ファンの動作確認、電源のON/OFF、リモコンの操作可否</li>
                    <li><strong>電圧測定・ヒューズ確認:</strong> 12V電圧の確認、ヒューズの状態チェック</li>
                    <li><strong>応急処置:</strong> バッテリー充電後再起動、ヒューズ交換、ドレンホース清掃</li>
                    <li><strong>本格修理:</strong> 冷媒ガス補充・真空引き、コンプレッサー・基板・ファンモーターの交換</li>
                    <li><strong>清掃作業:</strong> ドレンホース・室外ユニットの清掃、フィルター交換</li>
                    <li><strong>電子部品交換:</strong> リモコン・受光部・基板の交換、電源回路・ヒューズ・リレーの修理</li>
                    <li><strong>動作テスト:</strong> 冷房機能の確認、異音チェック、水漏れ確認</li>
                    <li><strong>予防策:</strong> 定期的なヒューズ・電圧チェック、冷媒漏れ点検</li>
                </ol>`;
            }
            // FFヒーターの場合の具体的な修理手順
            else if (result.content && (result.content.includes('FFヒーター') || result.content.includes('FF'))) {
                return `<ol>
                    <li><strong>安全確認:</strong> ガス供給を停止し、電源を切る</li>
                    <li><strong>外装取り外し:</strong> FFヒーターの外装カバーを慎重に取り外す</li>
                    <li><strong>フィルター清掃:</strong> エアフィルターを清掃または交換</li>
                    <li><strong>バーナー点検:</strong> バーナーの汚れや損傷を確認</li>
                    <li><strong>制御基板点検:</strong> 電子制御基板の動作を確認</li>
                    <li><strong>ファン点検:</strong> 送風ファンの動作と清掃</li>
                    <li><strong>ガス系統点検:</strong> ガスホースとバルブの点検</li>
                    <li><strong>動作テスト:</strong> 安全確認後、動作テストを実施</li>
                </ol>`;
            }
            // 雨漏りの場合の具体的な修理手順
            else if (result.content && result.content.includes('雨漏り')) {
                return `<ol>
                    <li><strong>原因特定:</strong> 水の侵入箇所を特定（ルーフ、窓枠、ドア周り）</li>
                    <li><strong>古いシーリング除去:</strong> カッターで古いシーリング材を除去</li>
                    <li><strong>清掃・乾燥:</strong> 作業箇所を清掃し、完全に乾燥させる</li>
                    <li><strong>マスキング:</strong> 周辺をマスキングテープで保護</li>
                    <li><strong>シーリング施工:</strong> ウレタンシーラントを均一に塗布</li>
                    <li><strong>仕上げ:</strong> 余分なシーリング材を除去し、仕上げ</li>
                    <li><strong>水密テスト:</strong> 水をかけて水密性を確認</li>
                </ol>`;
            }
            
            return `<ol>
                <li>問題箇所の特定</li>
                <li>安全確認と準備</li>
                <li>部品の交換・修理</li>
                <li>動作確認</li>
                <li>最終チェック</li>
            </ol>`;
        }

        // 注意事項を取得（改善版 - エアコン対応）
        function getWarnings(result) {
            if (result.warnings && result.warnings.length > 0) {
                return '<ul>' + result.warnings.map(warning => `<li>${warning}</li>`).join('') + '</ul>';
            } else if (result.structured_content && result.structured_content.causes) {
                return '<p><strong>考えられる原因と注意点:</strong></p><ul>' + 
                       result.structured_content.causes.map(cause => `<li>${cause}</li>`).join('') + '</ul>';
            }
            
            // エアコン専用の注意事項
            if (result.content && result.content.includes('エアコン')) {
                return `<ul>
                    <li><strong>車両電圧の安全確認:</strong> 12V電圧の確認、バッテリー状態の点検</li>
                    <li><strong>冷媒フロン類管理:</strong> 法律順守、適切な回収・廃棄処理</li>
                    <li><strong>高所・車外作業時の安全確保:</strong> 室外ユニット作業時の安全対策</li>
                    <li><strong>専門業者以外での分解・改造禁止:</strong> 冷媒系統の作業は専門知識が必要</li>
                    <li><strong>電気系統・高温部への注意:</strong> 感電・火傷の危険性</li>
                    <li><strong>換気確保:</strong> 密閉空間での作業時は十分な換気を確保</li>
                    <li><strong>工具の取り扱い:</strong> 電気工具の安全な使用</li>
                    <li><strong>部品確認:</strong> 純正部品または適合部品を使用</li>
                </ul>`;
            }
            // FFヒーターの場合の具体的な注意事項
            else if (result.content && (result.content.includes('FFヒーター') || result.content.includes('FF'))) {
                return `<ul>
                    <li><strong>ガス安全:</strong> ガス供給を必ず停止し、ガス検知器を使用</li>
                    <li><strong>換気確保:</strong> 作業中は十分な換気を確保し、一酸化炭素中毒に注意</li>
                    <li><strong>電気安全:</strong> 電源を完全に切り、感電防止対策を実施</li>
                    <li><strong>火気厳禁:</strong> ガス系統の作業中は火気を完全に除去</li>
                    <li><strong>専門知識:</strong> ガス器具の修理は有資格者または専門店に依頼</li>
                    <li><strong>部品確認:</strong> 純正部品または適合部品を使用</li>
                </ul>`;
            }
            // 雨漏りの場合の具体的な注意事項
            else if (result.content && result.content.includes('雨漏り')) {
                return `<ul>
                    <li><strong>高所作業:</strong> ルーフ作業は転落の危険があるため、安全帯の着用必須</li>
                    <li><strong>天候条件:</strong> 雨天時や強風時は作業を避ける</li>
                    <li><strong>シーリング材:</strong> ウレタンシーラントは皮膚に付着すると危険</li>
                    <li><strong>換気:</strong> 密閉空間での作業時は十分な換気を確保</li>
                    <li><strong>電気系統:</strong> 電気配線近くでの作業時は感電に注意</li>
                    <li><strong>専門知識:</strong> 複雑な構造の場合は専門店に相談</li>
                </ul>`;
            }
            
            return `<ul>
                <li>安全第一で作業を行ってください</li>
                <li>専門知識が必要な場合は専門店に相談</li>
                <li>工具の取り扱いには十分注意</li>
            </ul>`;
        }

        // 検索キーワードに基づいて動的に商品を生成
        function generateDynamicProducts(query) {
            const queryLower = query.toLowerCase();
            let products = [];
            
            // 雨漏り関連
            if (queryLower.includes('雨漏り') || queryLower.includes('水漏れ') || queryLower.includes('シーリング')) {
                products = [
                    { name: 'ウレタンシーラント 防水用', price: '¥1,200', description: '雨漏り防止用ウレタンシーラント', keywords: 'ウレタン,シーラント,防水,雨漏り' },
                    { name: 'ブチルテープ 防水用', price: '¥800', description: '応急防水用ブチルテープ', keywords: 'ブチル,テープ,防水,応急' },
                    { name: 'シーリングガン プロ用', price: '¥2,500', description: 'シーリング材施工用工具', keywords: 'シーリング,ガン,工具' },
                    { name: '窓枠モール 防水用', price: '¥3,200', description: '窓枠防水用モール', keywords: 'モール,窓枠,防水' },
                    { name: 'バックドア用ガスケット', price: '¥2,800', description: 'バックドア水漏れ防止用ガスケット', keywords: 'ガスケット,バックドア,水漏れ' }
                ];
            }
            // バッテリー関連
            else if (queryLower.includes('バッテリー') || queryLower.includes('充電') || queryLower.includes('電圧')) {
                products = [
                    { name: 'ディープサイクルバッテリー 12V', price: '¥15,000', description: 'キャンピングカー用ディープサイクルバッテリー', keywords: 'バッテリー,12V,ディープサイクル' },
                    { name: 'バッテリーチャージャー', price: '¥8,500', description: '多機能バッテリーチャージャー', keywords: 'チャージャー,充電,バッテリー' },
                    { name: 'バッテリー端子クリーナー', price: '¥1,200', description: 'バッテリー端子清掃用工具', keywords: '端子,クリーナー,清掃' },
                    { name: 'バッテリーテスター', price: '¥3,500', description: 'バッテリー状態測定器', keywords: 'テスター,測定,バッテリー' }
                ];
            }
            // トイレ関連
            else if (queryLower.includes('トイレ') || queryLower.includes('水洗') || queryLower.includes('カセット')) {
                products = [
                    { name: 'カセットトイレ用パッキン', price: '¥2,500', description: 'カセットトイレの水漏れ防止用', keywords: 'パッキン,カセット,トイレ' },
                    { name: 'トイレ用ポンプ', price: '¥12,500', description: '水洗トイレ用小型ポンプ', keywords: 'ポンプ,トイレ,水洗' },
                    { name: 'トイレ用除菌スプレー', price: '¥1,200', description: 'キャンピングカー専用除菌剤', keywords: '除菌,スプレー,トイレ' },
                    { name: 'カセットタンク', price: '¥8,900', description: '交換用カセットタンク', keywords: 'カセット,タンク,交換' }
                ];
            }
            // FFヒーター関連
            else if (queryLower.includes('ffヒーター') || queryLower.includes('ff') || queryLower.includes('ヒーター') || queryLower.includes('暖房')) {
                products = [
                    { name: 'FFヒーター本体', price: '¥45,000', description: 'キャンピングカー用FFヒーター本体', keywords: 'FFヒーター,本体,暖房' },
                    { name: 'FFヒーター用フィルター', price: '¥2,800', description: 'FFヒーター用エアフィルター', keywords: 'フィルター,FFヒーター,清掃' },
                    { name: 'FFヒーター用バーナー', price: '¥8,500', description: 'FFヒーター用バーナー部品', keywords: 'バーナー,FFヒーター,点火' },
                    { name: 'FFヒーター用ファン', price: '¥6,200', description: 'FFヒーター用送風ファン', keywords: 'ファン,送風,FFヒーター' },
                    { name: 'FFヒーター用制御基板', price: '¥12,000', description: 'FFヒーター用電子制御基板', keywords: '制御基板,電子,FFヒーター' }
                ];
            }
            // エアコン関連（カテゴリー候補と主要キーワード対応）
            else if (queryLower.includes('エアコン') || queryLower.includes('冷房') || queryLower.includes('冷暖房') || 
                     queryLower.includes('車載クーラー') || queryLower.includes('室内空調') || queryLower.includes('クライメート')) {
                products = [
                    { name: 'エアコンフィルター', price: '¥3,200', description: 'キャンピングカー用エアコンフィルター', keywords: 'フィルター,エアコン,清掃' },
                    { name: '冷媒ガス R134a', price: '¥4,500', description: 'エアコン用冷媒ガス', keywords: '冷媒,ガス,R134a' },
                    { name: 'エアコンクリーナー', price: '¥1,800', description: 'エアコン清掃用クリーナー', keywords: 'クリーナー,清掃,エアコン' },
                    { name: 'コンプレッサー部品', price: '¥25,000', description: 'エアコン用コンプレッサー部品', keywords: 'コンプレッサー,部品,エアコン' },
                    { name: 'ファンモーター', price: '¥8,500', description: 'エアコン用ファンモーター', keywords: 'ファン,モーター,送風' },
                    { name: '温度センサー', price: '¥3,800', description: 'エアコン用温度センサー', keywords: '温度,センサー,制御' },
                    { name: 'リモコン受光部', price: '¥2,200', description: 'エアコン用リモコン受光部', keywords: 'リモコン,受光部,操作' },
                    { name: 'ドレンホース', price: '¥1,500', description: 'エアコン用ドレンホース', keywords: 'ドレン,ホース,排水' },
                    { name: '制御基板', price: '¥12,000', description: 'エアコン用制御基板', keywords: '制御,基板,電子' },
                    { name: '電源回路部品', price: '¥4,800', description: 'エアコン用電源回路部品', keywords: '電源,回路,電気' }
                ];
            }
            // トイレ関連（カテゴリー候補と主要キーワード対応）
            else if (queryLower.includes('トイレ') || queryLower.includes('便器') || queryLower.includes('カセット') || 
                     queryLower.includes('toilet') || queryLower.includes('水漏れ') || queryLower.includes('詰まり') ||
                     queryLower.includes('排水') || queryLower.includes('ポンプ') || queryLower.includes('フラップ')) {
                products = [
                    { name: 'カセットトイレ用Oリング', price: '¥1,200', description: 'トイレタンク接続部用Oリング', keywords: 'Oリング,シール,水漏れ' },
                    { name: 'トイレ用給水ポンプ', price: '¥8,500', description: 'トイレ給水ポンプ', keywords: 'ポンプ,給水,水が出ない' },
                    { name: 'フラップシールキット', price: '¥3,800', description: 'トイレフラップ用シールキット', keywords: 'フラップ,シール,開かない' },
                    { name: 'トイレ用クリーナー', price: '¥2,200', description: 'トイレ専用クリーナー', keywords: 'クリーナー,清掃,詰まり' },
                    { name: 'バルブ部品', price: '¥4,500', description: 'トイレ用バルブ部品', keywords: 'バルブ,水漏れ,交換' },
                    { name: 'シリコングリス', price: '¥1,500', description: 'トイレ用シリコングリス', keywords: 'グリス,潤滑,シール' },
                    { name: '消臭薬剤', price: '¥800', description: 'トイレ用消臭薬剤', keywords: '消臭,薬剤,悪臭' },
                    { name: 'ヒューズセット', price: '¥600', description: 'トイレ用ヒューズセット', keywords: 'ヒューズ,電気,電源' },
                    { name: '配線ケーブル', price: '¥1,800', description: 'トイレ用配線ケーブル', keywords: '配線,ケーブル,電気' },
                    { name: '満杯センサー', price: '¥3,200', description: 'トイレ満杯センサー', keywords: 'センサー,満杯,ランプ' }
                ];
            }
            // 電装系関連
            else if (queryLower.includes('電装') || queryLower.includes('ヒューズ') || queryLower.includes('配線')) {
                products = [
                    { name: '12V ヒューズセット', price: '¥850', description: '各種容量のヒューズセット', keywords: 'ヒューズ,12V,セット' },
                    { name: '配線用ケーブル', price: '¥2,200', description: 'キャンピングカー用配線ケーブル', keywords: 'ケーブル,配線,電装' },
                    { name: 'マルチメーター', price: '¥4,500', description: '電圧・電流測定用マルチメーター', keywords: 'マルチメーター,測定,電圧' }
                ];
            }
            // デフォルト（一般的な工具・部品）
            else {
                products = [
                    { name: '基本工具セット', price: '¥8,500', description: 'キャンピングカー修理用基本工具セット', keywords: '工具,セット,基本' },
                    { name: 'マルチメーター', price: '¥4,500', description: '電圧・電流測定用マルチメーター', keywords: 'マルチメーター,測定,電圧' },
                    { name: '防水テープ', price: '¥600', description: '応急修理用防水テープ', keywords: '防水,テープ,応急' },
                    { name: '清掃用品セット', price: '¥2,800', description: 'キャンピングカー用清掃用品セット', keywords: '清掃,用品,セット' }
                ];
            }
            
            // 商品HTMLを生成
            let html = '<div class="product-grid">';
            products.forEach(product => {
                html += `
                    <div class="product-item" data-keywords="${product.keywords}">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price}</div>
                        <div class="product-description">${product.description}</div>
                        <button onclick="searchExternalProduct('${product.name}')" class="product-link">外部で検索</button>
                    </div>
                `;
            });
            html += '</div>';
            
            return html;
        }

        // 専門家セクションの番号を計算
        function getExpertSectionNumber(result) {
            let sectionNumber = 6; // 基本番号
            
            if (result.substitute_products?.length > 0) {
                sectionNumber++;
            }
            
            if (result.part_purchase_info?.length > 0) {
                sectionNumber++;
            }
            
            return sectionNumber;
        }

        // 完全な内容の表示切り替え
        function toggleFullContent(index) {
            const fullContent = document.getElementById(`fullContent${index}`);
            const button = fullContent.previousElementSibling;
            
            if (fullContent.style.display === 'none') {
                fullContent.style.display = 'block';
                button.textContent = '📖 完全な内容を非表示';
                button.classList.add('active');
            } else {
                fullContent.style.display = 'none';
                button.textContent = '📖 完全な内容を表示';
                button.classList.remove('active');
            }
        }

        // 詳細表示の切り替え
        function showFullContent(index) {
            toggleFullContent(index);
        }

        // セクションの折りたたみ切り替え
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                header.classList.add('active');
                icon.textContent = '▲';
            } else {
                content.style.display = 'none';
                header.classList.remove('active');
                icon.textContent = '▼';
            }
        }

        // クリップボードにコピー
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // 成功時のフィードバック
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '✅ コピー完了';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }).catch(function(err) {
                console.error('コピーに失敗しました: ', err);
                alert('コピーに失敗しました。手動でコピーしてください。');
            });
        }

        // 商品検索機能
        function searchProducts() {
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const productItems = document.querySelectorAll('.product-item');
            
            if (!searchTerm) {
                // 検索語が空の場合はすべて表示
                productItems.forEach(item => {
                    item.classList.remove('hidden', 'highlight');
                });
                return;
            }
            
            productItems.forEach(item => {
                const keywords = item.getAttribute('data-keywords') || '';
                const productName = item.querySelector('.product-name').textContent.toLowerCase();
                const description = item.querySelector('.product-description').textContent.toLowerCase();
                
                if (productName.includes(searchTerm) || 
                    description.includes(searchTerm) || 
                    keywords.includes(searchTerm)) {
                    item.classList.remove('hidden');
                    item.classList.add('highlight');
                } else {
                    item.classList.add('hidden');
                    item.classList.remove('highlight');
                }
            });
        }

        // カテゴリフィルタリング
        function filterProducts(category) {
            const categories = document.querySelectorAll('.product-category');
            const buttons = document.querySelectorAll('.category-btn');
            
            // ボタンのアクティブ状態を更新
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            categories.forEach(cat => {
                const catType = cat.getAttribute('data-category');
                
                if (category === 'all' || catType === category) {
                    cat.classList.remove('hidden');
                } else {
                    cat.classList.add('hidden');
                }
            });
            
            // 検索結果のハイライトをクリア
            const productItems = document.querySelectorAll('.product-item');
            productItems.forEach(item => {
                item.classList.remove('highlight');
            });
        }

        // 外部商品検索
        function searchExternalProduct(productName) {
            // 複数のECサイトで検索
            const searchQueries = [
                `https://www.amazon.co.jp/s?k=${encodeURIComponent(productName + ' キャンピングカー')}`,
                `https://search.rakuten.co.jp/search/mall/${encodeURIComponent(productName + ' キャンピングカー')}`,
                `https://shopping.yahoo.co.jp/search?p=${encodeURIComponent(productName + ' キャンピングカー')}`
            ];
            
            // ユーザーに選択肢を提示
            const choice = confirm(`「${productName}」を検索します。\n\nOK: Amazonで検索\nキャンセル: 他のサイトで検索`);
            
            if (choice) {
                window.open(searchQueries[0], '_blank');
            } else {
                // 複数サイトの選択肢を表示
                const siteChoice = confirm(`検索サイトを選択してください：\n\nOK: 楽天市場\nキャンセル: Yahoo!ショッピング`);
                const siteIndex = siteChoice ? 1 : 2;
                window.open(searchQueries[siteIndex], '_blank');
            }
        }

        // カテゴリ定義を取得する関数
        async function loadCategoriesFromAPI() {
            try {
                console.log('📋 カテゴリ定義をAPIから取得中...');
                const response = await fetch('/api/categories', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.categories) {
                    console.log('✅ カテゴリ定義取得成功:', Object.keys(data.categories));
                    
                    // カテゴリ情報をグローバル変数に保存
                    window.categoryDefinitions = data.categories;
                    
                    // カテゴリボタンを動的に生成
                    updateCategoryButtons(data.categories);
                    
                    return data.categories;
                } else {
                    console.error('❌ カテゴリ定義取得失敗:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('❌ カテゴリ定義取得エラー:', error);
                return null;
            }
        }
        
        // カテゴリボタンを動的に更新
        function updateCategoryButtons(categories) {
            const categoryContainer = document.querySelector('.search-categories');
            if (!categoryContainer) {
                console.warn('⚠️ カテゴリコンテナが見つかりません');
                return;
            }
            
            // 既存のボタンをクリア（「すべて」ボタンは残す）
            const allButton = categoryContainer.querySelector('button[onclick="filterProducts(\'all\')"]');
            categoryContainer.innerHTML = '';
            
            // 「すべて」ボタンを追加
            if (allButton) {
                categoryContainer.appendChild(allButton);
            }
            
            // カテゴリボタンを動的に生成
            Object.entries(categories).forEach(([categoryName, categoryInfo]) => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = `${categoryInfo.icon || '🔧'} ${categoryName}`;
                button.onclick = () => filterProducts(categoryName.toLowerCase());
                categoryContainer.appendChild(button);
            });
            
            console.log('✅ カテゴリボタンを動的に更新完了');
        }

        // Enterキーで検索
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('productSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchProducts();
                    }
                });
            }
            
            // ページ読み込み時にカテゴリ定義を取得
            loadCategoriesFromAPI();
        });

        // 結果要素の作成（従来版）
        function createResultElement(result, index) {
            const div = document.createElement('div');
            div.className = 'result-item fade-in';
            div.style.animationDelay = `${index * 0.1}s`;
            
            let urlsHtml = '';
            if (result.urls && result.urls.length > 0) {
                urlsHtml = `
                    <div class="url-info">
                        <strong>🔗 関連URL:</strong><br>
                        ${result.urls.map(url => `<a href="${url}" class="url-link" target="_blank">${url}</a>`).join('<br>')}
                    </div>
                `;
            }
            
            div.innerHTML = `
                <h3 class="result-title">${result.title}</h3>
                <span class="result-category">${result.category}</span>
                <div class="result-content">${result.content}</div>
                <div class="result-details">
                    <!-- 修理費用（非表示）
                    ${result.costs && result.costs.length > 0 ? `
                        <div class="cost-info">
                            <strong>💰 修理費用:</strong> ${result.costs.join(', ')}
                        </div>
                    ` : ''}
                    -->
                    ${result.alternatives && result.alternatives.length > 0 ? `
                        <div class="product-info">
                            <strong>🛠️ 推奨製品:</strong> ${result.alternatives.join(', ')}
                        </div>
                    ` : ''}
                    ${urlsHtml}
                </div>
            `;
            
            return div;
        }

        // 結果なし表示（非表示版）
        function displayNoResults(query) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsSection = document.getElementById('resultsSection');
            
            // 結果セクションを非表示にする
            resultsSection.classList.remove('show');
            console.log('⚠️ 検索結果なし - 結果セクションを非表示にしました');
        }

        // タグ検索
        function searchTag(tag) {
            document.getElementById('searchInput').value = tag;
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        }

        // エラー表示（非表示版）
        function displayError(message) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsSection = document.getElementById('resultsSection');
            
            // 結果セクションを非表示にする
            resultsSection.classList.remove('show');
            console.log('⚠️ エラー発生 - 結果セクションを非表示にしました:', message);
        }

        // ページ読み込み時のアニメーション
        window.addEventListener('load', function() {
            console.log('🚀 ページ読み込み完了');
            const elements = document.querySelectorAll('.fade-in');
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.opacity = '1';
                    element.style.transform = 'translateY(0)';
                }, index * 100);
            });
            
            // デバッグ情報の表示
            console.log('🔧 デバッグ情報:');
            console.log('- 検索フォーム:', document.getElementById('searchForm') ? '✅ 存在' : '❌ 不存在');
            console.log('- 検索入力:', document.getElementById('searchInput') ? '✅ 存在' : '❌ 不存在');
            console.log('- ローディング要素:', document.getElementById('loading') ? '✅ 存在' : '❌ 不存在');
            console.log('- 結果セクション:', document.getElementById('resultsSection') ? '✅ 存在' : '❌ 不存在');
            console.log('- 結果コンテナ:', document.getElementById('resultsContainer') ? '✅ 存在' : '❌ 不存在');
        });

        // タブ機能の実装
        function openAppPy() {
            console.log('🚀 app.pyを起動中...');
            // app.pyのパスを表示
            const appPath = 'C:\\Users\\user\\Desktop\\udemy-langchain\\camper-repair-clean\\app.py';
            const instructions = `アプリケーション起動手順:

1. ターミナル（コマンドプロンプト）を開く
2. 以下のコマンドを実行:
   cd C:\\Users\\user\\Desktop\\udemy-langchain\\camper-repair-clean
   start_backend_local.bat

または直接:
   python app.py

3. 起動後、http://localhost:5001 にアクセス

注意: OpenAI APIキーが必要です`;
            alert(instructions);
            
            // タブのアクティブ状態を更新
            updateTabActive('app');
        }

        function openFrontend() {
            console.log('🌐 フロントエンドを開く中...');
            // フロントエンドのURLを開く（同じウィンドウで開く）
            const frontendUrl = 'http://localhost:5001';
            
            // 接続テストを実行
            testConnection(frontendUrl).then(success => {
                if (success) {
                    window.location.href = frontendUrl;
                } else {
                    showConnectionError('フロントエンド', frontendUrl);
                }
            });
            
            // タブのアクティブ状態を更新
            updateTabActive('frontend');
        }

        function openBackend() {
            console.log('⚙️ バックエンド管理を開く中...');
            // バックエンド管理画面のURLを開く（同じウィンドウで開く）
            const backendUrl = 'http://localhost:5001/repair_advice_center.html';
            
            // 接続テストを実行
            testConnection(backendUrl).then(success => {
                if (success) {
                    window.location.href = backendUrl;
                } else {
                    showConnectionError('バックエンド管理', backendUrl);
                }
            });
            
            // タブのアクティブ状態を更新
            updateTabActive('backend');
        }

        function updateTabActive(activeTab) {
            // 全てのタブボタンからactiveクラスを削除
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // クリックされたタブにactiveクラスを追加
            event.target.classList.add('active');
        }

        // 接続テスト関数
        async function testConnection(url) {
            try {
                const response = await fetch(url, { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    timeout: 3000 
                });
                return true;
            } catch (error) {
                console.log('接続テスト失敗:', error);
                return false;
            }
        }

        // 接続エラー表示関数
        function showConnectionError(serviceName, url) {
            const errorMessage = `
${serviceName}に接続できません

URL: ${url}

解決方法:
1. Flaskアプリケーションを起動してください:
   python app.py

2. または、バッチファイルを使用:
   start_backend_local.bat

3. 起動後、再度タブをクリックしてください

注意: OpenAI APIキーの設定が必要です
            `;
            alert(errorMessage);
        }
    </script>
</body>
</html>
